<project default="compileFlex" basedir=".">
    <property file="local.build.properties"/>
    <taskdef resource="flexTasks.tasks" classpath="${flex.sdk.dir}/ant/lib/flexTasks.jar"/>

    <taskdef name="S3Upload" classname="dak.ant.taskdefs.S3Upload"/>


    <property name="FLEX_HOME" value="${flex.sdk.dir}"/>

    <property name="code.path" value="../out/code/"/>
    <property name="webapp.path" value="${code.path}/webapp"/>
    <property name="flex.path" value="${webapp.path}/easyui-debug"/>

    <target name="clean">
        <delete dir="${webapp.path}"/>
    </target>

    <target name="archive" depends="compileFlex">
        <zip destfile="${code.path}/code.zip" baseDir="${webapp.path}"/>
    </target>

    <target name="compileJava" depends="clean">
        <mkdir dir="${webapp.path}/WEB-INF/classes"/>
        <mkdir dir="${webapp.path}/assets"/>
        <mkdir dir="${webapp.path}/assets/icons"/>
        <mkdir dir="${webapp.path}/assets/icons/32x32"/>
        <mkdir dir="${webapp.path}/WEB-INF/flex"/>
        <mkdir dir="${webapp.path}/META-INF"/>
        <mkdir dir="${webapp.path}/WEB-INF/lib"/>

        <javac destdir="${webapp.path}/WEB-INF/classes"
               optimize="off"
               debug="on" failonerror="false"
               srcdir="../src"
               excludes="**/*.smap">
            <classpath>
                <fileset dir="../lib/cxf2">
                    <include name="*.jar"/>
                </fileset>
                <fileset dir="../lib/blazeds">
                    <include name="*.jar"/>
                </fileset>
                <fileset dir="../lib/core">
                    <include name="*.jar"/>
                </fileset>
                <fileset dir="../lib/commons">
                    <include name="*.jar"/>
                </fileset>
                <fileset dir="../lib/hibernate">
                    <include name="*.jar"/>
                </fileset>
                <fileset dir="../lib/google">
                    <include name="*.jar"/>
                </fileset>
                <fileset dir="../lib/excel">
                    <include name="*.jar"/>
                </fileset>
            </classpath>
            <include name="**"/>
            <exclude name="tags/**"/>
        </javac>
        <copy flatten="true" todir="${webapp.path}/WEB-INF/lib">
            <fileset dir="../lib">
                <include name="**/*"/>
            </fileset>
        </copy>
        <copy todir="${webapp.path}/WEB-INF/flex">
            <fileset dir="../web/WEB-INF/flex">
                <include name="**/*"/>
            </fileset>
        </copy>
        <copy todir="${webapp.path}/META-INF">
            <fileset dir="../web/META-INF">
                <include name="**/*"/>
            </fileset>
        </copy>
        <copy todir="${webapp.path}/WEB-INF">
            <fileset dir="../web/WEB-INF">
                <include name="*.xml"/>
            </fileset>
        </copy>
        <copy todir="${webapp.path}">
            <fileset dir="../web">
                <include name="**/*"/>
            </fileset>
        </copy>
        <copy todir="${webapp.path}/assets/icons/32x32">
            <fileset dir="../web/assets/icons/32x32">
                <include name="**/*"/>
            </fileset>
        </copy>
    </target>

    <target name="compileFlex" depends="compileJava">
        <mxmlc file="../../flex/src/PrimaryWorkspace.mxml" output="${flex.path}/PrimaryWorkspace.swf"
               static-rsls="false">
            <load-config filename="..\\..\\flex\\flex-config.xml"/>
            <runtime-shared-library-path path-element="${FLEX_HOME}/frameworks/libs/framework.swc">
                <url rsl-url="framework_3.1.0.2170.swz"/>
                <url policy-file-url=""/>
                <url rsl-url="framework_3.1.0.2170.swf"/>
                <url policy-file-url=""/>
            </runtime-shared-library-path>

            <runtime-shared-library-path path-element="${FLEX_HOME}/frameworks/libs/datavisualization.swc">
                <url rsl-url="datavisualization_3.1.0.2170.swz"/>
                <url policy-file-url=""/>
                <url rsl-url="datavisualization_3.1.0.2170.swf"/>
                <url policy-file-url=""/>
            </runtime-shared-library-path>

            <runtime-shared-library-path path-element="${FLEX_HOME}/frameworks/libs/rpc.swc">
                <url rsl-url="rpc_3.0.0.3.1.0.2170.swz"/>
                <url policy-file-url=""/>
                <url rsl-url="rpc_3.0.0.3.1.0.2170.swf"/>
                <url policy-file-url=""/>
            </runtime-shared-library-path>
        </mxmlc>

        <mxmlc file="../../flex/src/com/easyinsight/dashboard/ListViewModule.mxml" output="${flex.path}/ListViewModule.swf"
               static-rsls="false">
            <load-config filename="../../flex/list-module.xml"/>
            <runtime-shared-library-path path-element="${FLEX_HOME}/frameworks/libs/framework.swc">
                <url rsl-url="framework_3.1.0.2170.swz"/>
                <url policy-file-url=""/>
                <url rsl-url="framework_3.1.0.2170.swf"/>
                <url policy-file-url=""/>
            </runtime-shared-library-path>

            <runtime-shared-library-path path-element="${FLEX_HOME}/frameworks/libs/datavisualization.swc">
                <url rsl-url="datavisualization_3.1.0.2170.swz"/>
                <url policy-file-url=""/>
                <url rsl-url="datavisualization_3.1.0.2170.swf"/>
                <url policy-file-url=""/>
            </runtime-shared-library-path>

            <runtime-shared-library-path path-element="${FLEX_HOME}/frameworks/libs/rpc.swc">
                <url rsl-url="rpc_3.0.0.3.1.0.2170.swz"/>
                <url policy-file-url=""/>
                <url rsl-url="rpc_3.0.0.3.1.0.2170.swf"/>
                <url policy-file-url=""/>
            </runtime-shared-library-path>
        </mxmlc>
        <mxmlc file="../../flex/src/AdministrationApplication.mxml" output="${flex.path}/AdministrationApplication.swf" static-rsls="false">
            <load-config filename="../../flex/administration-app.xml"/>
            <runtime-shared-library-path path-element="${FLEX_HOME}/frameworks/libs/framework.swc">
                <url rsl-url="framework_3.1.0.2170.swz"/>
                <url policy-file-url=""/>
                <url rsl-url="framework_3.1.0.2170.swf"/>
                <url policy-file-url=""/>
            </runtime-shared-library-path>

            <runtime-shared-library-path path-element="${FLEX_HOME}/frameworks/libs/datavisualization.swc">
                <url rsl-url="datavisualization_3.1.0.2170.swz"/>
                <url policy-file-url=""/>
                <url rsl-url="datavisualization_3.1.0.2170.swf"/>
                <url policy-file-url=""/>
            </runtime-shared-library-path>

            <runtime-shared-library-path path-element="${FLEX_HOME}/frameworks/libs/rpc.swc">
                <url rsl-url="rpc_3.0.0.3.1.0.2170.swz"/>
                <url policy-file-url=""/>
                <url rsl-url="rpc_3.0.0.3.1.0.2170.swf"/>
                <url policy-file-url=""/>
            </runtime-shared-library-path>
        </mxmlc>
        <mxmlc file="../../flex/src/EmbeddedInsight.mxml" output="${flex.path}/EmbeddedInsight.swf" static-rsls="false">
            <load-config filename="../../flex/embedded-insight.xml"/>

            <runtime-shared-library-path path-element="${FLEX_HOME}/frameworks/libs/framework.swc">
                <url rsl-url="framework_3.1.0.2170.swz"/>
                <url policy-file-url=""/>
                <url rsl-url="framework_3.1.0.2170.swf"/>
                <url policy-file-url=""/>
            </runtime-shared-library-path>

            <runtime-shared-library-path path-element="${FLEX_HOME}/frameworks/libs/datavisualization.swc">
                <url rsl-url="datavisualization_3.1.0.2170.swz"/>
                <url policy-file-url=""/>
                <url rsl-url="datavisualization_3.1.0.2170.swf"/>
                <url policy-file-url=""/>
            </runtime-shared-library-path>

            <runtime-shared-library-path path-element="${FLEX_HOME}/frameworks/libs/rpc.swc">
                <url rsl-url="rpc_3.0.0.3.1.0.2170.swz"/>
                <url policy-file-url=""/>
                <url rsl-url="rpc_3.0.0.3.1.0.2170.swf"/>
                <url policy-file-url=""/>
            </runtime-shared-library-path>
        </mxmlc>
    </target>

    <target name="upload">
        <S3Upload verbose="true"
                  accessId="0AWCBQ78TJR8QCY8ABG2"
                  secretKey="bTUPJqHHeC15+g59BQP8ackadCZj/TsSucNwPwuI"
                  bucket="eiproduction"
                  publicRead="false">
            <fileset dir="../out/code" includes="code.zip"/>
        </S3Upload>
    </target>
</project>