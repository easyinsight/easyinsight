<?xml version="1.0" ?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" creationComplete="setup()">
    <mx:Script><![CDATA[
        import mx.controls.Alert;
        import mx.events.FlexEvent;
        import mx.managers.PopUpManager;
        import mx.rpc.events.FaultEvent;
        import mx.validators.Validator;

        private var _query:String;
        private var _dataSource:String;
        private var _mode:int;

        private var validators:Array;

        private function setup():void {
            validators = [ nameValidator ];
        }

        private function publish():void {
            var results:Array = Validator.validateAll(validators);
            if (results.length > 0) {
                Alert.show("Please correct errors before publishing.");
            } else {
                var queryConfiguration:QueryConfiguration = new QueryConfiguration();
                queryConfiguration.query = query;
                queryConfiguration.dataSource = dataSource;
                queryConfiguration.adHoc = false;
                queryConfiguration.name = nameInput.text;
                queryConfiguration.publishMode = mode;
                ProgressAlert.alert(this, "Publishing the query...", null, dbService.publishQuery);
                dbService.publishQuery.send(queryConfiguration);
            }
        }

        private function publishedQuery():void {
            dispatchEvent(new QueryPublishedEvent());
            PopUpManager.removePopUp(this);
        }

        private function onFault(event:FaultEvent):void {
            Alert.show(event.message.toString());
        }


        public function get mode():int {
            return _mode;
        }

        public function set mode(val:int):void {
            _mode = val;
            dispatchEvent(new FlexEvent(FlexEvent.DATA_CHANGE));
        }

        [Bindable]
        public function get query():String {
            return _query;
        }

        public function set query(val:String):void {
            _query = val;
            dispatchEvent(new FlexEvent(FlexEvent.DATA_CHANGE));
        }

        [Bindable]
        public function get dataSource():String {
            return _dataSource;
        }

        public function set dataSource(val:String):void {
            _dataSource = val;
            dispatchEvent(new FlexEvent(FlexEvent.DATA_CHANGE));
        }]]></mx:Script>
    <mx:RemoteObject id="dbService" destination="dbremote">
        <mx:method name="publishQuery" result="publishedQuery()"/>
    </mx:RemoteObject>
    <mx:VBox>
        <mx:VBox verticalGap="0" borderThickness="5" borderColor="#8296D2" borderStyle="solid" dropShadowEnabled="true" cornerRadius="15"
            paddingLeft="10" paddingBottom="10" paddingRight="10" paddingTop="10" backgroundColor="#E9ECF2">
            <mx:Box width="100%" horizontalAlign="center" paddingTop="5" paddingLeft="5" paddingBottom="5" paddingRight="5">
                <mx:Label text="Publish Query" fontFamily="Tahoma" fontWeight="bold" fontSize="14"/>
                <mx:TextArea text="This query will execute at midnight every night, sending its data to Easy Insight. Once you publish the query, you will no longer be able to alter the query from within this application unless you explicitly reenable the unchecked API in Easy Insight."
                          fontFamily="Tahoma" fontWeight="bold" fontSize="12" backgroundAlpha="0" borderThickness="0"
                        width="400" height="100"/>
            </mx:Box>
            <mx:Form width="100%" paddingBottom="5" paddingRight="5" paddingTop="5" paddingLeft="5">
                <mx:FormItem label="Please Name this Query:" fontFamily="Tahoma" fontWeight="bold">
                    <mx:TextInput id="nameInput" fontFamily="Lucida Grande" fontWeight="normal"/>
                </mx:FormItem>
                <mx:FormItem label="Data Source API Key: " fontFamily="Tahoma" fontWeight="bold">
                    <mx:Label text="{dataSource}" fontFamily="Lucida Grande" fontWeight="normal"/>
                </mx:FormItem>
                <mx:FormItem label="Query: " fontFamily="Tahoma" fontWeight="bold">
                    <mx:TextArea text="{query}" fontFamily="Lucida Grande" fontWeight="normal" editable="false" backgroundAlpha="0" width="300" height="80"/>
                </mx:FormItem>
            </mx:Form>
            <mx:HBox width="100%" horizontalAlign="center">
                <mx:Button label="Publish!" fontSize="14" click="publish()" fontWeight="bold"/>
                <mx:Button label="Cancel" click="PopUpManager.removePopUp(this)"/>
            </mx:HBox>
        </mx:VBox>
    </mx:VBox>
    <mx:StringValidator id="nameValidator" source="{nameInput}" minLength="3" property="text"/>
</mx:TitleWindow>