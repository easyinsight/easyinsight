<?xml version="1.0" ?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:account="com.easyinsight.account.*"
                backgroundColor="#FFFFFF">
    <mx:Script><![CDATA[
        import com.easyinsight.framework.User;
        import com.easyinsight.framework.UserServiceResponse;
        import mx.messaging.config.ServerConfig;
        import mx.rpc.AsyncResponder;
        import mx.rpc.AsyncToken;
        import mx.rpc.events.FaultEvent;
        import mx.rpc.events.ResultEvent;

        private function handleAuthentication():void {
            var authResult:UserServiceResponse= authService.authenticate.lastResult as UserServiceResponse;
            var successful:Boolean = authResult.successful;
            if (successful) {
                User.initializeUser(authResult.name, authResult.email,
                    authResult.accountType, authResult.spaceAllowed, authResult.accountAdmin,
                        authResult.dataSourceCreator, authResult.insightCreator, authResult.userID);
                User.getInstance().password = authResult.encryptedPassword;
                User.getInstance().userName = authResult.userName;
                ExternalInterface.call("widget.setValue", "userName", userName.text);
                ExternalInterface.call("widget.setValue", "password", password.text);
                currentState = "MyGoals";
            } else {
                failureMessageLabel.text = authResult.failureMessage;
            }
        }

        private function login():void {
            if (authService.channelSet == null) {
                authService.channelSet = ServerConfig.getChannelSet(authService.destination);
            }
            var token:AsyncToken = authService.channelSet.login(userName.text, password.text);
            token.addResponder(new AsyncResponder(
                function (event:ResultEvent, token:Object = null):void {
                    switch (event.result) {
                        case "success":
                            authService.authenticate.send(userName.text, password.text);
                            break;
                        default:
                            trace(event.result);
                    }
                },
                function (event:FaultEvent, token:Object = null):void {
                    switch (event.fault.faultCode) {
                        case "Client.Authentication":
                        default:
                            var failureMessage:String = event.fault.faultString;
                            failureMessageLabel.text = failureMessage;
                    }
                }
            ));
        }
]]></mx:Script>
    <mx:RemoteObject id="authService" destination="login">
		<mx:method name="authenticate" result="handleAuthentication()"/>
	</mx:RemoteObject>
    <mx:Style source="com/easyinsight/skin/osx/OSX.css"/>
    <mx:VBox id="coreBox" width="100%" height="100%" horizontalAlign="center">
		<mx:Form id="loginForm">
			<mx:FormItem label="User Name: ">
				<mx:TextInput id="userName"/>
			</mx:FormItem>
			<mx:FormItem label="Password: ">
				<mx:TextInput id="password" displayAsPassword="true"/>
			</mx:FormItem>
			<mx:FormItem label="">
				<mx:Label id="failureMessageLabel"/>
			</mx:FormItem>
			<mx:FormItem label="">
				<mx:Button label="Log In" click="login()"/>
			</mx:FormItem>
		</mx:Form>
	</mx:VBox>
    <account:AccountAdministration/>
</mx:Application>