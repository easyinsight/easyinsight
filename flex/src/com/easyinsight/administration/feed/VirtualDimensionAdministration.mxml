<?xml version="1.0" ?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:feed="com.easyinsight.administration.feed.*"
        width="100%" height="100%">
    <mx:Script><![CDATA[
        import com.easyinsight.analysis.AnalysisItem;

        import com.easyinsight.analysis.AnalysisItemTypes;

        import com.easyinsight.util.PopUpUtil;

        import mx.collections.ArrayCollection;
        import mx.events.ListEvent;
        import mx.managers.PopUpManager;

        public function save():void {
            dimensionEditor.save();
        }

        public function getVirtualDimensions():ArrayCollection {
            return virtualDimensions;
        }

        [Bindable]
        private var virtualDimensions:ArrayCollection;

        private var _feedDefinition:FeedDefinitionData;

        [Bindable]
        private var dimension:VirtualDimension;

        [Bindable]
        private var _dataSourceID:int;

        private var groupings:ArrayCollection;

        override protected function commitProperties():void {
            super.commitProperties();
            this.virtualDimensions = _feedDefinition.virtualDimensions;
            _dataSourceID = _feedDefinition.dataFeedID;
        }

        public function set feedDefinition(val:FeedDefinitionData):void {
            _feedDefinition = val;
            groupings = new ArrayCollection();
            for each (var field:AnalysisItem in _feedDefinition.fields) {
                if (field.hasType(AnalysisItemTypes.DIMENSION) && field.virtualDimension == null) {
                    groupings.addItem(field);
                }
            }
        }

        public function set dataSourceID(val:int):void {
            _dataSourceID = val;
        }

        private function addVirtualDimension():void {
            var window:NewVirtualDimensionWindow = new NewVirtualDimensionWindow();
            window.groupings = groupings;
            window.addEventListener(NewVirtualDimensionEvent.NEW_VIRTUAL_DIMENSION, onDimension);
            PopUpManager.addPopUp(window, this, true);
            PopUpUtil.centerPopUp(window);
        }

        private function onDimension(event:NewVirtualDimensionEvent):void {
            event.currentTarget.removeEventListener(NewVirtualDimensionEvent.NEW_VIRTUAL_DIMENSION, onDimension);
            virtualDimensions.addItem(event.dimension);
        }

        private function onItemClick(event:ListEvent):void {
            if (this.dimension != null) {
                dimensionEditor.save();
            }
            this.dimension = virtualDimensions.getItemAt(event.rowIndex) as VirtualDimension;
        }

        ]]></mx:Script>
    <mx:VBox width="100%" height="100%">
        <mx:Button label="Add Virtual Dimension..." click="addVirtualDimension()"/>
        <mx:HBox width="100%" height="100%">
            <mx:List dataProvider="{virtualDimensions}" itemClick="onItemClick(event)" labelField="name"/>
            <feed:VirtualDimensionEditor dimension="{dimension}" id="dimensionEditor" dataSourceID="{_dataSourceID}"/>
        </mx:HBox>
    </mx:VBox>
</mx:Canvas>