<?xml version="1.0"?>
<util:EITitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:util="com.easyinsight.util.*">
    <mx:Script><![CDATA[
        import com.easyinsight.account.Account;
        import com.easyinsight.framework.User;

        import mx.managers.PopUpManager;
        import mx.rpc.events.FaultEvent;
        import mx.validators.Validator;

        private var _dataSource:FeedDefinitionData;

        public function set dataSource(value:FeedDefinitionData):void {
            _dataSource = value;
        }

        protected override function commitProperties():void {
            super.commitProperties();
            dataSourceName = _dataSource.feedName;
            accountVisible = _dataSource.accountVisible;
            dataSourceDescription = _dataSource.description;
            if (_dataSource.dataFeedID == 0) {
                dataSourceShare = "yes";
            } else {
                dataSourceShare = _dataSource.accountVisible ? "yes" : "no";
            }
        }

        [Bindable]
        private var accountVisible:Boolean;

        [Bindable]
        private var stackIndex:int;

        [Bindable]
        private var dataSourceName:String;

        [Bindable]
        private var dataSourceDescription:String;

        [Bindable]
        private var dataSourceShare:String;

        [Bindable]
        private var errorText:String;

        private function save():void {
            var results:Array = Validator.validateAll([dataSourceNameValidator]);
            if (results.length > 0) {
                dataSourceNameInput.setFocus();
                dataSourceNameInput.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OVER));
                return;
            } else {
                dataSourceName = dataSourceNameInput.text;
                dataSourceDescription = dataSourceDescriptionInput.text;
            }
            _dataSource.feedName = dataSourceName;
            _dataSource.description = dataSourceDescription;
            _dataSource.accountVisible = sharingGroup.selectedValue == "yes";
            stackIndex = 1;
            feedService.updateFeedDefinition.send(_dataSource);
        }

        private function saved():void {
            dispatchEvent(new DataSourceSaveEvent());
            PopUpManager.removePopUp(this);
        }

        private function onFault(event:FaultEvent):void {
            errorText = event.fault.faultString;
            stackIndex = 2;
        }
        ]]></mx:Script>
    <mx:RemoteObject id="feedService" destination="feeds">
		<mx:method name="updateFeedDefinition" result="saved()" fault="onFault(event)"/>
	</mx:RemoteObject>
    <mx:ViewStack selectedIndex="{stackIndex}" width="550" height="400" backgroundColor="#FFFFFF">
        <mx:VBox height="100%" width="100%" paddingBottom="10" paddingLeft="10" paddingRight="10" paddingTop="10" styleName="fallThroughFonts">
            <!-- what do you want to call this report? -->
            <mx:Label text="What do you want to name this data source?" fontSize="14" fontWeight="bold"/>
            <mx:TextInput text="{dataSourceName}" id="dataSourceNameInput" width="530" fontSize="14"/>
            <mx:Spacer height="20"/>
            <mx:Label text="Do you want to share this data source with other users in the account?" fontSize="14"
                      fontWeight="bold"/>
            <mx:RadioButtonGroup id="sharingGroup" selectedValue="{dataSourceShare}"/>
            <mx:HBox width="100%" horizontalAlign="center">
                <mx:RadioButton label="Yes" value="yes" groupName="sharingGroup" fontSize="14" tabIndex="0"/>
                <mx:RadioButton label="No" value="no" groupName="sharingGroup" fontSize="14" tabIndex="1"/>
            </mx:HBox>
            <mx:Label text="How do you want to describe this data source?" fontSize="14" fontWeight="bold"/>
            <mx:TextArea width="530" height="75" id="dataSourceDescriptionInput"
                                 text="{dataSourceDescription}" fontSize="14" borderStyle="inset" borderThickness="1"/>
            <mx:Spacer height="100%"/>
            <mx:HBox width="100%" horizontalAlign="center">
                <util:SaveButton label="Save" click="save()" fontSize="14"/>
                <util:CancelButton label="Cancel" click="PopUpManager.removePopUp(this)" fontSize="14"/>
            </mx:HBox>
        </mx:VBox>
        <mx:Box width="100%" height="100%" horizontalAlign="center" verticalAlign="middle">
            <mx:ProgressBar label="Saving the data source..." indeterminate="true"/>
        </mx:Box>
        <mx:VBox width="100%" height="100%" horizontalAlign="center" paddingLeft="10" paddingBottom="10" paddingRight="10" paddingTop="10">
            <mx:Label text="We're sorry, but something went wrong in saving the data source." fontSize="14"/>
            <mx:TextArea borderStyle="none" backgroundAlpha="0" text="{errorText}" width="400" height="200" editable="false"/>
            <mx:Button label="Close" click="PopUpManager.removePopUp(this)" fontSize="14"/>
        </mx:VBox>
    </mx:ViewStack>
    <mx:StringValidator id="dataSourceNameValidator" source="{dataSourceNameInput}" property="text" minLength="3" maxLength="100"/>
</util:EITitleWindow>
