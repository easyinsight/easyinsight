<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute" width="800" height="500" 
	xmlns:feed="com.easyinsight.administration.feed.*">
	<mx:Script>
		<![CDATA[
			import com.easyinsight.salesforce.SalesforceSubFeedDefinition;
			import com.easyinsight.salesforce.SalesforceFeedDefinition;
			import com.easyinsight.feedassembly.CompositeFeedDefinition;
			import com.easyinsight.customupload.FileBasedFeedDefinition;
			import mx.controls.Alert;
            import mx.rpc.events.FaultEvent;
            import mx.rpc.events.ResultEvent;
            import mx.managers.PopUpManager;
            import com.easyinsight.listing.DataFeedDescriptor;
            import mx.events.ItemClickEvent;
            import com.easyinsight.images.ImageFactory;

            [Bindable]
            private var feedState:FeedState;

            public function setDataFeedDescriptor(dataFeedDescriptor:DataFeedDescriptor):void {
                uploadService.getDataFeedConfiguration.send(dataFeedDescriptor.dataFeedID);						
                //this.feedState = new FeedState(dataFeedDescriptor);
            }

            private function tabClick(event:ItemClickEvent):void {
                viewStack.selectedIndex = event.index;
                var feedTabWindow:FeedTabWindow = viewStack.selectedChild as FeedTabWindow;
                feedTabWindow.feedStateEstablished();
            }

            private function save():void {
                feedLabeling.updateState();
                feedFields.updateState();
                feedPolicy.updateState();
                var feedDefinition:FeedDefinitionData = this.feedState.createFeedDefinitionData();
                uploadService.updateFeedDefinition(feedDefinition);
            }

            private function cancel():void {
                PopUpManager.removePopUp(this);
            }

            private function gotUpdate(event:ResultEvent):void {
            	dispatchEvent(new FeedUpdateEvent());
                PopUpManager.removePopUp(this);
            }

            private function failure(event:FaultEvent):void {
                Alert.show(event.fault.message);
            }

            private function gotDataFeedConfiguration(event:ResultEvent):void {
                var feedDefinition:FeedDefinitionData = uploadService.getDataFeedConfiguration.lastResult as FeedDefinitionData;
                this.feedState = new FeedState(feedDefinition);
                var feedTabWindow:FeedTabWindow = viewStack.selectedChild as FeedTabWindow;
                feedTabWindow.feedStateEstablished();
            }
            
            private static function classDefs():void {
            	var fileDef:FileBasedFeedDefinition;
            	var compositeFeedDef:CompositeFeedDefinition;
            	var salesforceFeedDef:SalesforceFeedDefinition;
            	var salesforceSubDef:SalesforceSubFeedDefinition;
            }
        ]]>
	</mx:Script>
	<mx:RemoteObject id="uploadService" destination="userUpload">
		<mx:method name="updateFeedDefinition" result="gotUpdate(event)" fault="failure(event)"/>
		<mx:method name="getDataFeedConfiguration" result="gotDataFeedConfiguration(event)" fault="failure(event)"/>		
	</mx:RemoteObject>
	<mx:VBox width="100%" height="100%" styleName="TitleWindowContents">
		<mx:HBox width="100%" height="100%">
			<mx:Box borderStyle="solid" borderThickness="1">								
				<mx:TabBar direction="vertical" itemClick="tabClick(event)" width="150">
					<mx:dataProvider>
						<mx:String>Labeling</mx:String>
						<mx:String>Fields</mx:String>
						<mx:String>Policy</mx:String>
					</mx:dataProvider>
				</mx:TabBar>
			</mx:Box>
			<mx:ViewStack id="viewStack" width="100%" height="100%" creationPolicy="all">
				<feed:FeedLabeling feedState="{feedState}" id="feedLabeling"/>
				<feed:FeedFields feedState="{feedState}" id="feedFields"/>
				<feed:FeedPolicy feedState="{feedState}" id="feedPolicy"/>
			</mx:ViewStack>
		</mx:HBox>
		<mx:HBox width="100%" horizontalAlign="center">
			<mx:Button label="Save" click="save()"/>
			<mx:Button label="Cancel" click="cancel()"/>
		</mx:HBox>
	</mx:VBox>
</mx:TitleWindow>
