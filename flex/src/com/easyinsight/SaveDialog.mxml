<?xml version="1.0" encoding="utf-8"?>
<util:EISlimWindow xmlns:util="com.easyinsight.util.*" xmlns:mx="http://www.adobe.com/2006/mxml"
                    creationComplete="addEventListener(KeyboardEvent.KEY_UP, keyHit); focusManager.setFocus(analysisName);
	validators = [nameValidator]">
    <mx:Script>
		<![CDATA[
        import com.easyinsight.analysis.CopyReportWindow;
        import com.easyinsight.analysis.SavedAnalysisEvent;
        import com.easyinsight.util.PopUpUtil;
        import com.easyinsight.util.ProgressAlert;

        import mx.managers.PopUpManager;

        import com.easyinsight.analysis.AnalysisDefinition;

        import mx.validators.Validator;

        [Bindable]
        public var analysisDefinition:AnalysisDefinition;

        private var validators:Array;

        private function save():void {
            var results:Array = Validator.validateAll(validators);
            if (results.length == 0) {
                ProgressAlert.alert(this, "Saving report...", null, analysisService.saveAs);
                analysisService.saveAs(analysisDefinition, analysisName.text);
                PopUpManager.removePopUp(this);
            } else {
                analysisName.setFocus();
                analysisName.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OVER));
            }
        }

        private function keyHit(event:KeyboardEvent):void {
            if (event.keyCode == Keyboard.ENTER) {
                save();
            }
        }

        private function cancel():void {
            PopUpManager.removePopUp(this);
        }

        private function saved():void {
            var savedDef:AnalysisDefinition = analysisService.saveAs.lastResult as AnalysisDefinition;
            //AnalysisUtil.updateReport(analysisDefinition, savedDef);
            dispatchEvent(new SavedAnalysisEvent(savedDef));
            PopUpManager.removePopUp(this);
        }

        private function copyToAnotherDataSource():void {
            var window:CopyReportWindow = new CopyReportWindow();
            window.report = analysisDefinition;
            window.addEventListener(SavedAnalysisEvent.SAVED_ANALYSIS, passThrough);
            PopUpManager.addPopUp(window, this, true);
            PopUpUtil.centerPopUp(window);
        }

        private function passThrough(event:SavedAnalysisEvent):void {
            dispatchEvent(event);
        }
                ]]>
    </mx:Script>
    <mx:VBox width="100%" height="100%">
        <mx:Form>
            <mx:FormItem label="Report Name:" direction="horizontal">
                <mx:TextInput id="analysisName" width="300"/>
            </mx:FormItem>
            <mx:FormItem label="" direction="horizontal">
                <util:SaveButton label="Save" click="save()"/>
                <util:SaveButton label="Copy to Another Data Source" click="copyToAnotherDataSource()"/>
                <util:CancelButton label="Cancel" click="cancel()"/>
            </mx:FormItem>
        </mx:Form>
    </mx:VBox>
    <mx:StringValidator source="{analysisName}" property="text" minLength="2" id="nameValidator"/>
    <mx:RemoteObject id="analysisService" destination="analysisDefinition">
        <mx:method name="saveAs" result="saved()"/>
    </mx:RemoteObject>
</util:EISlimWindow>