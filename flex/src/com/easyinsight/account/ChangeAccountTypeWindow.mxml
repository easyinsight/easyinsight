<?xml version="1.0" ?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:account="com.easyinsight.account.*" xmlns:containers="flexlib.containers.*"
                creationComplete="setup()" backgroundColor="#F5F6F9" paddingBottom="20" paddingLeft="20" paddingRight="20" paddingTop="20">
    <mx:Metadata>
        [Event(name="refreshAccount", type="com.easyinsight.account.RefreshAccountEvent")]
    </mx:Metadata>
    <mx:states>
        <mx:State name="Confirmation">
            <mx:RemoveChild target="{upgradeBox}"/>
            <mx:AddChild relativeTo="{coreContent}">
                <account:AccountConfirmationUpgrade previousPage="backFromConfirm()" accountCreationConfirmed="onConfirm()" creationComplete="onCreationComplete()" account="{newAccountType}"/>
            </mx:AddChild>
        </mx:State>
        <mx:State name="ContactUs">
            <mx:RemoveChild target="{upgradeBox}"/>
            <mx:AddChild relativeTo="{coreContent}">
                <account:TypeContactUs id="contactUs" previousPage="previousPage();"/>
            </mx:AddChild>
        </mx:State>
        <mx:State name="BillingInformation">
            <mx:RemoveChild target="{upgradeBox}" />
            <mx:AddChild relativeTo="{coreContent}">
                <account:AccountBillingInformation id="billingInformation" previousPage="previousPage()" />
            </mx:AddChild>
        </mx:State>
    </mx:states>
    <mx:Script><![CDATA[
        import com.easyinsight.framework.UpgradeAccountResponse;
        import com.easyinsight.framework.User;
        import com.easyinsight.framework.UserTransferObject;
import mx.controls.Alert;
        import mx.controls.Spacer;
        import mx.managers.PopUpManager;

        private function previousPage():void {
            currentState = "";
        }

        private function onCreationComplete():void {
            //PopUpManager.centerPopUp(this);
            this.y = 100;
            this.x = 100;
//            var point1:Point = new Point();
//            point1.x = 0;
//            point1.y = 0;
//            this.localToGlobal(point1);
//            this.y = point1.y - 100;
        }

        [Bindable]
        [Embed(source="../../../../assets/bullet_ball_blue.png")]
        private var bulletIcon:Class;

        private var currentAccountType:String;

        [Bindable]
        private var individualAvailable:Boolean;

        [Bindable]
        private var professionalAvailable:Boolean;

        [Bindable]
        private var groupAvailable:Boolean;

        [Bindable]
        private var enterpriseAvailable:Boolean;

        private var billingInfo:BillingInfo;

        [Bindable]
        private var newAccountType:int;

        private function onBillingInfo(event:BillingInfoDefinitionEvent):void {
            billingInfo = event.billingInfo;
            currentState = "Confirmation";
        }

        private function backFromConfirm():void {
            currentState = "";
        }

        private function onConfirm():void {
            userService.upgradeAccount.send(newAccountType);
        }

        private function upgradedAccount():void {
            var response:UpgradeAccountResponse = userService.upgradeAccount.lastResult as UpgradeAccountResponse;
            var user:UserTransferObject = response.user;
            User.getInstance().resync(user);
            User.getInstance().setAccountType(newAccountType);
            dispatchEvent(new RefreshAccountEvent());

            if(response.billingInformationNeeded) {
                currentState = "BillingInformation";
            }
            else {
                PopUpManager.removePopUp(this);
                Alert.show("Account upgraded!");
            }
        }

        private function backFromBilling():void {
            currentState = "";
        }

        private function setup():void {
            var accountType:int = User.getInstance().getAccountType();
            var spacer:Spacer;
            switch(accountType) {
            case Account.FREE:
                var individual:IndividualAccountInfo = new IndividualAccountInfo();
                individual.addEventListener(UpgradeEvent.UPGRADE_EVENT, upgradeToIndividual);
                flowBox.addChild(individual);
            case Account.INDIVIDUAL:
                spacer = new Spacer();
                spacer.width = 30;
                flowBox.addChild(spacer);
                var group:GroupAccountInfo = new GroupAccountInfo();
                group.addEventListener(UpgradeEvent.UPGRADE_EVENT, upgradeToGroup);
                flowBox.addChild(group);
                flowBox.height = 450;
            case Account.GROUP:
                    spacer = new Spacer();
                    spacer.width = 30;
                var professional:ProfessionalAccountInfo = new ProfessionalAccountInfo();
                professional.addEventListener(UpgradeEvent.UPGRADE_EVENT, upgradeToProfessional);
                flowBox.addChild(spacer);
                flowBox.addChild(professional);
            case Account.PROFESSIONAL:
                spacer = new Spacer();
                spacer.width = 30;
                    flowBox.addChild(spacer);
                    var enterprise:EnterpriseAccountInfo = new EnterpriseAccountInfo();
                    enterprise.addEventListener(UpgradeEvent.UPGRADE_EVENT, upgradeToProfessional);
                    flowBox.addChild(enterprise);
                break;
            default:
                break;
            }
        }

        private function upgradeToIndividual(event:UpgradeEvent):void {
            newAccountType = Account.INDIVIDUAL;
            currentState = "Confirmation";
        }

        private function upgradeToGroup(event:UpgradeEvent):void {
            newAccountType = Account.GROUP;
            currentState = "Confirmation";
        }

        private function upgradeToProfessional():void {
            newAccountType = Account.PROFESSIONAL;
            currentState = "ContactUs";
        }
        ]]></mx:Script>
    <mx:RemoteObject id="userService" destination="accountAdmin">
        <mx:method name="upgradeAccount" result="upgradedAccount()"/>
    </mx:RemoteObject>
    <mx:VBox id="coreContent">
        <mx:VBox id="upgradeBox" verticalGap="20">
            <mx:HBox horizontalAlign="center" width="100%">
                <mx:Label text="You can upgrade to the following options:" fontSize="14" fontWeight="bold" fontFamily="Tahoma"/>                                
            </mx:HBox>
            <containers:FlowBox width="600" height="250" id="flowBox">
            </containers:FlowBox>
            <mx:HBox width="100%" horizontalAlign="center">
                <mx:Button label="Cancel" click="PopUpManager.removePopUp(this)"/>
            </mx:HBox>
        </mx:VBox>
    </mx:VBox>
</mx:TitleWindow>