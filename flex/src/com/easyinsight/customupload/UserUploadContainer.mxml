<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute" width="800" height="500" 
	xmlns:customupload="com.easyinsight.customupload.*" creationComplete="initHandlers()">
	<mx:states>
		<!-- configuration of the file type/parsing, key output is an UploadFormat -->
		<mx:State name="UploadParsingConfiguration">
			<mx:RemoveChild target="{userUploader}"/>
			<mx:AddChild relativeTo="{coreCanvas}" creationPolicy="all">
				<customupload:UserUploadParse id="parseConfiguration"/>
			</mx:AddChild>	
		</mx:State>
		<!-- configuration of feed name and fields, output is going to be name, genre, and lists of measures/dimensions -->
		<mx:State name="UploadMetadataConfiguration">
			<mx:RemoveChild target="{userUploader}"/>
			<mx:AddChild relativeTo="{coreCanvas}" creationPolicy="all">
				<customupload:TypeAssignment id="metadataConfiguration"/>
			</mx:AddChild>
		</mx:State>
	</mx:states>
	
	<mx:Script>
		<![CDATA[
			import mx.managers.PopUpManager;
			
			private function initHandlers():void {
				userUploader.addEventListener(UserUploadEvent.USER_UPLOAD_COMPLETE, uploadComplete);
				userUploader.addEventListener(UploadCancelEvent.UPLOAD_CANCEL, uploadConfigCancelled);
				
				parseConfiguration.addEventListener(UploadParseCompleteEvent.UPLOAD_PARSE_COMPLETE, parseComplete);
				parseConfiguration.addEventListener(UploadCancelEvent.UPLOAD_CANCEL, uploadConfigCancelled);
				
				metadataConfiguration.addEventListener(UploadMetadataCompleteEvent.UPLOAD_METADATA_COMPLETE, metadataComplete);
				metadataConfiguration.addEventListener(UploadCancelEvent.UPLOAD_CANCEL, uploadConfigCancelled);				
			}
			
			private function uploadComplete(event:UserUploadEvent):void {
				this.currentState = "UploadParsingConfiguration";
				parseConfiguration.go(event.uploadID);				
			}
			
			private function parseComplete(event:UploadParseCompleteEvent):void {
				this.currentState = "UploadMetadataConfiguration";
				metadataConfiguration.go(event.uploadID, event.uploadFormat);
			}
			
			private function metadataComplete(event:UploadMetadataCompleteEvent):void {
				// complete the damn thing
				dispatchEvent(new UploadConfigEvent(UploadConfigEvent.UPLOAD_CONFIG_COMPLETE, event.feedID));
				PopUpManager.removePopUp(this);				 
			}
			
			private function uploadConfigCancelled(event:UploadCancelEvent):void {
				PopUpManager.removePopUp(this);
				//dispatchEvent(new UploadConfigEvent(event.type, event.dataFeedID));							
			}
			
			private function uploadConfigDone(event:UploadConfigEvent):void {
				PopUpManager.removePopUp(this);
				//dispatchEvent(new UploadConfigEvent(event.type, event.dataFeedID));
			}
		]]>
	</mx:Script>
	
	<mx:Box id="coreCanvas" width="100%" height="100%" styleName="TitleWindowContents">		
		<customupload:UserUpload id="userUploader"/>
	</mx:Box>
</mx:TitleWindow>
