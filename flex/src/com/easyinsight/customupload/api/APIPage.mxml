<?xml version="1.0" ?>
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:api="com.easyinsight.customupload.api.*"
         xmlns:listing="com.easyinsight.listing.*" xmlns:util="com.easyinsight.util.*"
         implements="com.easyinsight.listing.IPerspective" width="100%" height="100%"
         creationComplete="setupListeners()" verticalGap="0">
    <mx:Script><![CDATA[
        import com.easyinsight.account.APIUserAdmin;
        import com.easyinsight.account.AccountAPISettings;
        import com.easyinsight.customupload.SimpleFeedWindow;
        import com.easyinsight.customupload.UploadConfigEvent;        
        import com.easyinsight.framework.User;
        import com.easyinsight.listing.AnalyzeSource;
        import com.easyinsight.util.PopUpUtil;

        import mx.collections.ArrayCollection;
        import mx.managers.BrowserManager;
        import mx.managers.PopUpManager;
        import mx.utils.URLUtil;

        private function gotSettings():void {
            var settings:AccountAPISettings = userService.getAccountAPISettings.lastResult as AccountAPISettings;
            if (settings.apiEnabled) {
                apiLabel = "The API is currently enabled for your account.";
            } else {
                if (User.getInstance().accountAdmin) {
                    apiLabel = "The API is currently disabled for your account.";
                } else {
                    apiLabel = "The API is currently disabled for your account.";
                }
            }
        }

        private function onAPIUpdate(event:APIUpdateEvent):void {
            userService.getAccountAPISettings.send();
        }

        private function apiInformation():void {
            var window:APIUserAdmin = new APIUserAdmin();
            window.addEventListener(APIUpdateEvent.API_UPDATE, onAPIUpdate, false, 0, true);
            PopUpManager.addPopUp(window, this, true);
            PopUpUtil.centerPopUp(window);
        }

        [Bindable]
        private var services:ArrayCollection;

        [Bindable]
        private var apis:ArrayCollection;

        [Bindable]
        private var apiLabel:String;

        private function setupListeners():void {
            factory = new DataSourceAPIEditControlsFactory(this);
            servicesGrid.addEventListener(ServiceDefinitionEvent.SERVICE_REMOVED, serviceRemoved);
        }

        public function analyze():AnalyzeSource {
            return null;
        }

        public function gotFocus():void {
            var fragmentObject:Object = new Object();
            fragmentObject.page = "apis";
            BrowserManager.getInstance().setTitle("Easy Insight - API Management");
            var fragmentString:String = URLUtil.objectToString(fragmentObject);
            BrowserManager.getInstance().setFragment(fragmentString);            
            apiService.getDataSourceAPIs.send();
            userService.getAccountAPISettings.send();
        }

        public function getDefaultAnalyzeState():Boolean {
            return false;
        }

        public function isKeywordSearchInstant():Boolean {
            return false;
        }

        [Bindable]
        private var factory:DataSourceAPIEditControlsFactory;

        private function gotDeployedServices():void {
            this.services = apiService.getDeployedServices.lastResult as ArrayCollection;
        }

        private function addService():void {
            var serviceFeedChoice:ServiceFeedChoice = ServiceFeedChoice(PopUpManager.createPopUp(this, ServiceFeedChoice, true));
            serviceFeedChoice.addEventListener(ServiceDefinitionEvent.SERVICE_DEFINED, serviceDefined);
            PopUpUtil.centerPopUp(serviceFeedChoice);
        }

        private function serviceDefined(event:ServiceDefinitionEvent):void {
            apiService.getDeployedServices.send();
        }

        private function serviceRemoved(event:ServiceDefinitionEvent):void {
            apiService.getDeployedServices.send();
        }

        private function help():void {
            var helpWindow:DynamicServiceHelpWindow = DynamicServiceHelpWindow(PopUpManager.createPopUp(this,
                    DynamicServiceHelpWindow, true));
            PopUpUtil.centerPopUp(helpWindow);
        }

        private function gotAPIs():void {
            this.apis = apiService.getDataSourceAPIs.lastResult as ArrayCollection;
        }

        private function viewValidatedWSDL():void {
            navigateToURL(new URLRequest("https://www.easy-insight.com/app/services/EIDataV2?wsdl"), "_blank");
        }


        private function createEmptyFeed():void {
            var userUpload:SimpleFeedWindow = SimpleFeedWindow(PopUpManager.createPopUp(this, SimpleFeedWindow, true));
            userUpload.addEventListener(UploadConfigEvent.UPLOAD_CONFIG_COMPLETE, uploadConfigComplete);
            PopUpUtil.centerPopUp(userUpload);
        }

        private function uploadConfigComplete(event:UploadConfigEvent):void {
            apiService.getDataSourceAPIs.send();
        }

        private function search():void {
        }

        public function cleanup():void {
        }]]></mx:Script>
    <mx:RemoteObject destination="accountAdmin" id="userService">
        <mx:method name="getAccountAPISettings" result="gotSettings()"/>
    </mx:RemoteObject>
    <mx:RemoteObject destination="apiService" id="apiService">
        <mx:method name="getDeployedServices" result="gotDeployedServices()"/>
        <mx:method name="getDataSourceAPIs" result="gotAPIs()"/>
    </mx:RemoteObject>
    <mx:VBox width="100%" height="100%" backgroundColor="#818285" horizontalAlign="center">
        <mx:VBox id="coreContent" height="100%" width="1000" paddingTop="10" paddingLeft="10" paddingRight="10"
                 paddingBottom="10" verticalGap="10" backgroundColor="#FFFFFF">
            <mx:Box paddingLeft="10" paddingTop="10" paddingRight="10" paddingBottom="10" width="100%" height="100%"
                    verticalGap="10" id="apiListing">

                <mx:HBox width="100%" verticalAlign="middle">
                    <mx:TextArea text="The Easy Insight API gives you a SOAP interface to publish in your data. You can access the API with an account level of Basic or higher."
                             borderStyle="none" backgroundAlpha="0" editable="false" selectable="false" width="300" height="50"/>
                    <mx:VBox horizontalAlign="center">
                        <mx:Label text="{apiLabel}"/>
                        <mx:Button label="My API Information..." click="apiInformation()" styleName="redButton"/>
                    </mx:VBox>

                    <!--<mx:Button icon="{helpIcon}" toolTip="Help!" click="help()"/>-->
                    <mx:Spacer width="100%"/>
                    <mx:HBox borderStyle="inset" borderThickness="1" paddingTop="5" paddingBottom="5" paddingLeft="5"
                             paddingRight="5">
                        <mx:TextInput id="searchText" keyUp="search()"/>
                        <mx:Button toolTip="Search" icon="@Embed(source='../../../../../assets/view.png')"
                                   id="searchButton"/>
                    </mx:HBox>
                </mx:HBox>
                <mx:HBox width="100%" height="100%" verticalGap="0">
                    <mx:VBox verticalGap="0">
                        <mx:Box width="100%" height="5" backgroundColor="#D42525" left="0" right="0"/>
                        <mx:Box width="100%" backgroundColor="#F6A76B" horizontalAlign="center">
                            <mx:Label text="Standard Web Service API"/>
                        </mx:Box>
                        <mx:Form paddingTop="0" paddingLeft="0" paddingRight="0" paddingBottom="0"
                                 backgroundColor="#F5CDAF">
                            <mx:FormItem label="API Information" fontFamily="Tahoma" fontWeight="bold"
                                         direction="vertical">
                                <mx:LinkButton textDecoration="underline" label="View WSDL" fontFamily="Lucida Grande"
                                               fontWeight="normal" click="viewValidatedWSDL()"/>
                            </mx:FormItem>
                        </mx:Form>
                    </mx:VBox>
                    <mx:VBox verticalGap="0" height="100%">
                        <mx:Box width="100%" height="5" backgroundColor="#D42525" left="0" right="0"/>
                        <mx:Box width="100%" backgroundColor="#F6A76B" horizontalAlign="center">
                            <mx:Label text="Data Sources and their API Configurations"/>
                        </mx:Box>
                        <mx:DataGrid dataProvider="{apis}" width="700" height="100%" selectable="false"
                                     id="servicesGrid" rowHeight="28">
                            <mx:columns>
                                <util:EIDataGridColumn headerText="Data Source Name" dataField="name"/>
                                <util:EIDataGridColumn headerText="Unique API Key" width="120" dataField="apiKey"/>
                                <util:EIDataGridColumn headerText="" width="50" dataField="apiKey" sortable="false"
                                        itemRenderer="com.easyinsight.customupload.api.CopyAPIButton"/>
                                <util:EIDataGridColumn headerText="" width="60" dataField="feedName"
                                                   itemRenderer="{factory}" sortable="false"/>
                            </mx:columns>
                        </mx:DataGrid>
                    </mx:VBox>
                </mx:HBox>
            </mx:Box>
        </mx:VBox>
    </mx:VBox>
</mx:VBox>