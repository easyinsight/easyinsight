<?xml version="1.0" ?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" creationComplete="retrieveFields()">
    <mx:Script><![CDATA[
import com.easyinsight.administration.feed.FeedDefinitionData;
        import mx.managers.PopUpManager;
        import mx.collections.ArrayCollection;
        [Bindable]
        private var methods:ArrayCollection;

        private var _dynamicServiceDefinition:DynamicServiceDefinition;
        private var _feedID:int;
        private var fields:ArrayCollection;

        public function get dynamicServiceDefinition():DynamicServiceDefinition {
            return _dynamicServiceDefinition;
        }
        public function set dynamicServiceDefinition(val:DynamicServiceDefinition):void {
            _dynamicServiceDefinition = val;
        }

        public function set feedID(val:int):void {
            _feedID = val;
        }

        override protected function createChildren():void {
            super.createChildren();
            if (_dynamicServiceDefinition != null) {
                this.methods = _dynamicServiceDefinition.configuredMethods;
            }
        }

        private function save():void {
            _dynamicServiceDefinition.configuredMethods = methods;
            apiService.deployServiceDefinition.send(_dynamicServiceDefinition);
        }

        private function deployed():void {
            PopUpManager.removePopUp(this);
        }

        private function editMethod(event:EditMethodEvent):void {
            var methodEditWindow:MethodEditWindow = new MethodEditWindow();
            methodEditWindow.configuredMethod = event.configuredMethod;
            methodEditWindow.fields = fields;
            methodEditWindow.addEventListener(MethodDefinitionEvent.METHOD_EDITED, onMethodEdit);
            PopUpManager.addPopUp(methodEditWindow, this, true);
            PopUpManager.centerPopUp(methodEditWindow);
        }

        private function onMethodEdit(event:MethodDefinitionEvent):void {
             
        }

        private function retrieveFields():void {
            methodsGrid.addEventListener(MethodDefinitionEvent.METHOD_REMOVED, onMethodRemove);
            methodsGrid.addEventListener(EditMethodEvent.EDIT_METHOD, editMethod);
            uploadService.getDataFeedConfiguration.send(_feedID);
        }

        private function onMethodRemove(event:MethodDefinitionEvent):void {
            methods.removeItemAt(methods.getItemIndex(event.method));
        }

        private function gotFeed():void {
            var feed:FeedDefinitionData = uploadService.getDataFeedConfiguration.lastResult as FeedDefinitionData;
            this.fields = feed.fields;
        }

        private function cancel():void {
            PopUpManager.removePopUp(this);
        }

        private function addMethod():void {
            var methodEditWindow:MethodEditWindow = new MethodEditWindow();
            methodEditWindow.fields = this.fields;
            methodEditWindow.addEventListener(MethodDefinitionEvent.METHOD_DEFINED, onMethodDefined);
            PopUpManager.addPopUp(methodEditWindow, this, true);
            PopUpManager.centerPopUp(methodEditWindow);
        }

        private function onMethodDefined(event:MethodDefinitionEvent):void {
            methods.addItem(event.method);
        }

        ]]></mx:Script>
    <mx:RemoteObject destination="userUpload" id="uploadService">
        <mx:method name="getDataFeedConfiguration" result="gotFeed()"/>
    </mx:RemoteObject>
    <mx:RemoteObject destination="apiService" id="apiService">
		<mx:method name="deployServiceDefinition" result="deployed()"/>
	</mx:RemoteObject>
    <mx:VBox>
        <mx:ApplicationControlBar>
            <mx:Label text="Methods"/>
            <mx:Button label="Add Method..." click="addMethod()"/>
        </mx:ApplicationControlBar>
        <mx:DataGrid dataProvider="{methods}" id="methodsGrid"  width="100%" height="100%" rowHeight="24">
            <mx:columns>
                <mx:DataGridColumn headerText="Method Name" dataField="methodName" />
                <mx:DataGridColumn headerText="" dataField="methodName" itemRenderer="com.easyinsight.customupload.api.DynamicServiceEditControls" width="50"/>
            </mx:columns>
        </mx:DataGrid>
        <mx:HBox width="100%" horizontalAlign="center">
            <mx:Button label="Save" click="save()"/>
            <mx:Button label="Cancel" click="cancel()"/>
        </mx:HBox>
    </mx:VBox>
</mx:TitleWindow>