<?xml version="1.0" ?>
<util:EITitleWindow xmlns:util="com.easyinsight.util.*" xmlns:mx="http://www.adobe.com/2006/mxml" close="PopUpManager.removePopUp(this);" creationComplete="onCreationComplete()"
        title="Password Reset">
    <mx:Form>
        <mx:FormItem label="User Name or Email Address:">
            <mx:TextInput id="userName" />
        </mx:FormItem>
        <mx:FormItem label="Password:">
            <mx:TextInput id="password" displayAsPassword="true" />
        </mx:FormItem>
        <mx:FormItem label="Confirm Password:">
            <mx:TextInput id="confirmPassword" displayAsPassword="true" />
        </mx:FormItem>
        <mx:FormItem>
            <mx:HBox>
                <mx:Button label="Submit" click="submitPasswordReset();" /> <mx:Button label="Cancel" click="dispatchEvent(new CloseEvent(CloseEvent.CLOSE));" /> 
            </mx:HBox>
        </mx:FormItem>
        <mx:FormItem>
            <mx:Text id="failureMessageLabel"/>
        </mx:FormItem>
    </mx:Form>
    <mx:RemoteObject id="userService" destination="login">
        <mx:method name="resetPassword" result="passwordReset()" />
    </mx:RemoteObject>
    <mx:StringValidator source="{password}" property="text" id="passwordValidator" minLength="8" maxLength="20"/>
    <mx:Script><![CDATA[
        import com.easyinsight.util.ProgressAlert;

        import mx.controls.Alert;
        import mx.events.CloseEvent;
        import mx.managers.PopUpManager;
        import mx.validators.Validator;

        private function passwordReset():void {
            if(userService.resetPassword.lastResult as Boolean) {
                Alert.show("Your password has been reset. You can now log in.");
                dispatchEvent(new CloseEvent(CloseEvent.CLOSE));
            } else {
                Alert.show("There was an error with resetting your password - either your username is incorrect, or the password reset request has expired.");
            }
        }

        private var validators:Array;

        private function onCreationComplete():void {
            validators = [ passwordValidator ];
        }

        private var _passwordValidation:String;

        public function get passwordValidation():String {
            return _passwordValidation;
        }

        public function set passwordValidation(value:String):void {
            _passwordValidation = value;
        }

        private function submitPasswordReset():void {
            if(Validator.validateAll(validators).length > 0) {
                password.setFocus();
                password.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OVER));
                return;
            }
            if(password.text != confirmPassword.text) {
                failureMessageLabel.text = "Your passwords do not match.";
                return;
            }
            ProgressAlert.alert(this, "Resetting your password...", null, userService.resetPassword);
            userService.resetPassword.send(_passwordValidation, userName.text, password.text);
        }
        ]]></mx:Script>
</util:EITitleWindow>