<?xml version="1.0"?>
<util:EISlimWindow xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:util="com.easyinsight.util.*"
        creationComplete="setup()">
    <mx:Script><![CDATA[
        import com.easyinsight.customupload.UploadConfigEvent;
        import com.easyinsight.quicksearch.EIDescriptor;

        import com.easyinsight.util.ProgressAlert;

        import mx.controls.Alert;
        import mx.managers.PopUpManager;
        import mx.validators.Validator;

        private function setup():void {
            addEventListener(KeyboardEvent.KEY_UP, function(event:KeyboardEvent):void {
                if (event.keyCode == Keyboard.ENTER) {
                    obtainTicket();
                }
            });
        }

        private function obtainTicket():void {
            var results:Array = Validator.validateAll([userNameValidator, passwordValidator]);
            if (results.length == 0) {
                ProgressAlert.alert(this, "Authenticating with Quickbase...", null, quickbaseService.authenticate)
                quickbaseService.authenticate.send(userNameInput.text, passwordInput.text);
            }
        }

        private function authenticated():void {
            var response:QuickbaseResponse = quickbaseService.authenticate.lastResult as QuickbaseResponse;
            if (response.errorMessage != null) {
                Alert.show(response.errorMessage);
            } else {
                ProgressAlert.alert(this, "Creating the data source, may take a few minutes...", null, quickbaseService.createDataSource);
                quickbaseService.createDataSource.send(response.sessionTicket);
            }
        }

        private function createdDataSource():void {
            var descriptor:EIDescriptor = quickbaseService.createDataSource.lastResult as EIDescriptor;
            dispatchEvent(new UploadConfigEvent(UploadConfigEvent.UPLOAD_CONFIG_COMPLETE, descriptor.id, descriptor.name));
            PopUpManager.removePopUp(this);
        }
        ]]></mx:Script>
    <mx:RemoteObject destination="google" id="quickbaseService">
        <mx:method name="authenticate" result="authenticated()"/>
        <mx:method name="createDataSource" result="createdDataSource()"/>
    </mx:RemoteObject>
    <mx:VBox>
        <mx:Form>
            <mx:FormItem label="Quickbase User Name:">
                <mx:TextInput id="userNameInput"/>
            </mx:FormItem>
            <mx:FormItem label="Quickbase Password:">
                <mx:TextInput id="passwordInput" displayAsPassword="true"/>
            </mx:FormItem>
        </mx:Form>
        <mx:HBox width="100%" horizontalAlign="center">
            <mx:Button label="Create" click="obtainTicket()" styleName="grayButton"/>
            <mx:LinkButton label="Cancel" click="PopUpManager.removePopUp(this)" textDecoration="underline"/>
        </mx:HBox>
    </mx:VBox>
    <mx:StringValidator id="userNameValidator" minLength="1" source="{userNameInput}" property="text"/>
    <mx:StringValidator id="passwordValidator" minLength="1" source="{passwordInput}" property="text"/>
</util:EISlimWindow>
