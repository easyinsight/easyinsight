<?xml version="1.0" encoding="utf-8"?>
<util:EITitleWindow xmlns:util="com.easyinsight.util.*" xmlns:mx="http://www.adobe.com/2006/mxml"
                    xmlns:suggestion="com.easyinsight.suggestion.*" layout="absolute"
                    creationComplete="onCreation()" backgroundColor="#FFFFFF">
	<mx:Script>
		<![CDATA[
        import com.easyinsight.dashboard.DashboardDescriptor;
        import com.easyinsight.quicksearch.EIDescriptor;

        import mx.collections.ArrayCollection;
        import mx.collections.Sort;
        import mx.collections.SortField;
        import mx.managers.PopUpManager;

        [Bindable]
        private var descriptors:ArrayCollection;

        public var dataSourceType:int;

        private function onCreation():void {
            ProgressAlert.alert(this, "Getting reports...", null, adminService.getAvailableReports);
            adminService.getAvailableReports.send(dataSourceType);
        }


        private function chose():void {
            if (reportBox.selectedItem == null) {
                return;
            }
            var selected:EIDescriptor = reportBox.selectedItem as EIDescriptor;
            dispatchEvent(new ConnectionDescriptorEvent(ConnectionDescriptorEvent.CONNECTION_ADD, selected));
            PopUpManager.removePopUp(this);
        }


        private function cancel():void {
            PopUpManager.removePopUp(this);
        }

        private var validReports:ArrayCollection;

        [Bindable]
        private var nextLevelReports:ArrayCollection;

        [Bindable]
        private var selectedID:int;

        private function gotReports():void {
            var results:ReportResults = adminService.getAvailableReports.lastResult as ReportResults;
            validReports = results.reports;
            for each (var d:DashboardDescriptor in results.dashboards) {
                validReports.addItem(d);
            }
            var sort:Sort = new Sort();
            sort.fields = [ new SortField("name", true)];
            validReports.sort = sort;
            tags = results.reportTags;
            validReports.filterFunction = filterFunction;
            validReports.refresh();
            nextLevelReports = new ArrayCollection(validReports.toArray());
            var dataSources:ArrayCollection = results.dataSources;
            if (dataSources == null) {
                dataSources = new ArrayCollection();
            }
            var none:Object = { name:"[ All Data Sources ]", id:0};
            dataSources.addItemAt(none, 0);
            this.dataSources = dataSources;
        }

        [Bindable]
        private var tags:ArrayCollection;

        private function filterFunction(object:Object):Boolean {
            var report:EIDescriptor = object as EIDescriptor;
            return tagBox.filterObject(report);
        }

        private function onTagSelect(event:TagSelectionEvent):void {
            validReports.refresh();
            nextLevelReports = new ArrayCollection(validReports.toArray());
            reportBox.closeDropdown();
        }

        [Bindable]
        private var dataSources:ArrayCollection;

        private var dataSourceID:int;
        ]]>
	</mx:Script>
    <mx:RemoteObject id="adminService" destination="admin">
        <mx:method name="getAvailableReports" result="gotReports()"/>
    </mx:RemoteObject>
    <mx:VBox paddingBottom="10" paddingLeft="10" paddingRight="10" paddingTop="10">
        <mx:Form id="form">
            <mx:FormItem label="Filter by Tags:" labelWidth="120">
                <util:TagBox tags="{tags}" onTagSelect="onTagSelect(event)" id="tagBox" width="300"/>
            </mx:FormItem>
        </mx:Form>
        <mx:HRule width="100%"/>
        <mx:Form>
            <mx:FormItem label="Choose a Report:" labelWidth="120">
                <suggestion:Reports dataProvider="{nextLevelReports}" labelField="name" id="reportBox"/>
            </mx:FormItem>
        </mx:Form>
        <mx:HRule width="100%"/>
        <mx:HBox width="100%" horizontalAlign="center">
                <util:SaveButton label="OK" click="chose()"/>
                <util:CancelButton label="Cancel" click="cancel()"/>
        </mx:HBox>
    </mx:VBox>
</util:EITitleWindow>
