<?xml version="1.0" ?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" backgroundColor="#D8DBEE" borderThickness="1" borderStyle="solid" borderColor="0x000000"
           cornerRadius="15" dropShadowEnabled="true">
    <mx:states>
        <mx:State name="Done">
            <mx:RemoveChild target="{progressBox}"/>
            <mx:AddChild relativeTo="{coreBox}">
                <mx:VBox horizontalAlign="center">
                    <mx:Label text="{completeText}" fontWeight="bold" fontSize="14" fontFamily="Tahoma"/>
                    <mx:Button label="OK" click="cancel()"/>
                </mx:VBox>
            </mx:AddChild>
        </mx:State>
        <mx:State name="Failure">
            <mx:RemoveChild target="{progressBox}"/>
            <mx:AddChild relativeTo="{coreBox}">
                <mx:VBox horizontalAlign="center">
                    <mx:TextArea borderStyle="none" backgroundAlpha="0" fontWeight="bold" width="200" height="200" 
                                 text="Sorry, but we encountered the following error in trying to complete the operation:" fontSize="14" fontFamily="Tahoma"/>
                    <mx:Label text="{errorText}"/>
                    <mx:Button label="Cancel" click="cancel()"/>
                </mx:VBox>
            </mx:AddChild>
        </mx:State>
    </mx:states>
    <mx:Script><![CDATA[
        import mx.events.FlexEvent;
        import flash.events.Event;
        import mx.managers.PopUpManager;
        import mx.rpc.events.FaultEvent;

        private var _progressText:String;
        private var _completeText:String;
        [Bindable]
        private var errorText:String;

        private var _targetSource:Object;

        private var failed:Boolean;

        private function cancel():void {
            PopUpManager.removePopUp(this);
        }


        public function set targetSource(val:Object):void {
            _targetSource = val;
            val.addEventListener( Event.COMPLETE, onBlah );            
        }

        [Bindable]
        public function get completeText():String {
            return _completeText;
        }

        public static function alert(parent:DisplayObject, progressText:String, completeText:String, source:EventDispatcher):FileAlert {
            var alert:FileAlert = new FileAlert();
            alert.progressText = progressText;
            alert.completeText = completeText;
            alert.targetSource = source;
            PopUpManager.addPopUp(alert, parent, true);
            PopUpManager.centerPopUp(alert);
            return alert;
        }

        private function onBlah(event:Event):void {
            if (!failed) {
                if (_completeText == null) {
                    PopUpManager.removePopUp(this);
                } else {
                    currentState = "Done";
                }
            }
        }

        private function onFault(event:FaultEvent):void {
            failed = true;
            errorText = event.fault.faultString;
            currentState = "Failure";
        }

        public function set completeText(val:String):void {
            _completeText = val;
            dispatchEvent(new FlexEvent(FlexEvent.DATA_CHANGE));
        }

        [Bindable]
        public function get progressText():String {
            return _progressText;
        }

        public function set progressText(val:String):void {
            _progressText = val;
            dispatchEvent(new FlexEvent(FlexEvent.DATA_CHANGE));
        }]]></mx:Script>
    <mx:VBox id="coreBox" width="100%" height="100%" horizontalAlign="center" verticalAlign="middle"
             paddingBottom="20" paddingLeft="20" paddingRight="20" paddingTop="20">
        <mx:VBox id="progressBox" horizontalAlign="center">
            <mx:Label text="{progressText}" fontWeight="bold" fontSize="14" fontFamily="Tahoma"/>
            <mx:ProgressBar indeterminate="true"/>
            <mx:Button label="Cancel" click="cancel()"/>
        </mx:VBox>
    </mx:VBox>
</mx:Canvas>