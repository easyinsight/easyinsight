<?xml version="1.0" ?>
<mx:Module xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:kpi="com.easyinsight.kpi.*"
           creationComplete="determineEditor()" width="100%" height="100%">
    <mx:Script><![CDATA[
        import com.easyinsight.framework.User;

        import mx.core.IFlexDisplayObject;
        import mx.managers.PopUpManager;

        [Bindable]
        private var _scorecardID:int;

        private var _groupID:int;
        [Bindable]
        private var _kpi:KPI;

        [Bindable(event="groupIDChanged")]
        public function get groupID():int {
            return _groupID;
        }

        public function set groupID(value:int):void {
            if (_groupID == value) return;
            _groupID = value;
            dispatchEvent(new Event("groupIDChanged"));
        }

        private function determineEditor():void {

            if (User.getSharedObject() != null) {
                var editorType:String = User.getSharedObject().data["kpiEditor"];
                if (editorType != null) {
                    if (editorType == "wizard") {
                        stackIndex = 1;
                    } else if (editorType == "expert") {
                        stackIndex = 2;
                    }
                }
            }
            if (stackIndex == 0) {
                stackIndex = 1;
            }
        }

        public function set scorecardID(value:int):void {
            _scorecardID = value;
        }

        public function set kpi(value:KPI):void {
            _kpi = value;
        }

        private function onKPIEvent(event:KPIEvent):void {
            PopUpManager.removePopUp(IFlexDisplayObject(this.parent.parent));
        }

        private function toExpertMode():void {
            stackIndex = 2;
            if (User.getSharedObject() != null) {
                User.getSharedObject().data["kpiEditor"] = "expert";
            }
        }

        private function toWizardMode():void {
            stackIndex = 1;
            if (User.getSharedObject() != null) {
                User.getSharedObject().data["kpiEditor"] = "wizard";
            }
        }

        [Bindable]
        private var stackIndex:int = 0;

        ]]></mx:Script>

    <mx:ViewStack selectedIndex="{stackIndex}" resizeToContent="true" width="100%" height="100%">
        <mx:Box/>
        <kpi:KPIWizard kpi="{_kpi}" scorecardID="{_scorecardID}" kpiAdded="onKPIEvent(event)"
                       kpiEdited="onKPIEvent(event)"
                       expertMode="toExpertMode()" width="100%" height="100%" kpiCancel="PopUpManager.removePopUp(IFlexDisplayObject(this.parent.parent))"
                       groupID="{groupID}"/>
        <kpi:KPIWindow kpi="{_kpi}" scorecardID="{_scorecardID}" kpiAdded="onKPIEvent(event)"
                       kpiEdited="onKPIEvent(event)"
                       wizardMode="toWizardMode()" width="100%" height="100%" kpiCancel="PopUpManager.removePopUp(IFlexDisplayObject(this.parent.parent))"
                       groupID="{groupID}"/>
    </mx:ViewStack>
</mx:Module>