<?xml version="1.0"?>
<mx:HBox xmlns:mx="http://www.adobe.com/2006/mxml" horizontalAlign="center" width="100%" backgroundColor="{bgColor}">
    <mx:Script><![CDATA[
        import com.easyinsight.SimpleReportEditor;
        import com.easyinsight.analysis.DataViewFactory;
        import com.easyinsight.datasources.DataSourceInfo;

        import mx.collections.ArrayCollection;

        [Bindable]
        private var problemText:String;

        public var intentionSuggestion:IntentionSuggestion;

        override protected function commitProperties():void {
            super.commitProperties();
            if (intentionSuggestion.priority == IntentionSuggestion.WARNING) {
                bgColor = 0x888800;
            } else if (intentionSuggestion.priority == IntentionSuggestion.YOU_SHOULD_REALLY_DO_THIS) {
                bgColor = 0x000088;
            }
            problemText = intentionSuggestion.description;
        }

        [Bindable]
        private var bgColor:uint = 0x880000;

        public var simpleReportEditor:SimpleReportEditor;

        public var fields:ArrayCollection;

        public var dataSourceID:int;

        private var _fields:ArrayCollection;
        private var _wrappers:ArrayCollection;

        private var _dataSourceDisplay:DataSourceInfo;
        private var _allFields:ArrayCollection;
        private var _dataView:DataViewFactory;

        private function resolve():void {
            if (intentionSuggestion.requiresServerCallback) {
                analysisService.getIntentions.send(simpleReportEditor.analysisDefinition, _fields, intentionSuggestion.scope, intentionSuggestion.type);
            } else {
                new SuggestionFactory(simpleReportEditor).argh(intentionSuggestion.type, _fields, simpleReportEditor.analysisDefinition.dataFeedID);
            }
        }

        private function gotIntentions():void {
            var intentions:ArrayCollection = analysisService.getIntentions.lastResult as ArrayCollection;
            var metadata:SuggestionMetadata = new SuggestionMetadata(simpleReportEditor.analysisDefinition, simpleReportEditor.transformContainer,
                    _allFields, _wrappers, _dataSourceDisplay, simpleReportEditor);
            for each (var intention:Intention in intentions) {
                intention.addEventListener(IntentionTriggerEvent.INTENTION_TRIGGER, onIntentionEvent);
                intention.apply(metadata);
            }
            if (_dataView != null) {
                _dataView.refresh();
            }
        }

        private function onIntentionEvent(event:IntentionTriggerEvent):void {
            dispatchEvent(event);
        }
        ]]></mx:Script>
    <mx:RemoteObject id="analysisService" destination="analysisDefinition">
        <mx:method name="getIntentions" result="gotIntentions()"/>
    </mx:RemoteObject>
    <mx:Text htmlText="{problemText}" click="resolve()" textDecoration="underline" color="#FFFFFF" fontSize="14" styleName="fallThroughFonts" useHandCursor="true" buttonMode="true"
            selectable="false" mouseEnabled="true" mouseChildren="false" maxWidth="600"/>
</mx:HBox>
