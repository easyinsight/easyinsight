<?xml version="1.0" ?>
<mx:Box xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:viewStackEffects="org.efflex.mx.viewStackEffects.*"
        xmlns:framework="com.easyinsight.framework.*" xmlns:account="com.easyinsight.account.*"
        xmlns:kpi="com.easyinsight.kpi.*" xmlns:customupload="com.easyinsight.customupload.*"
        xmlns:guest="com.easyinsight.guest.*"
        backgroundColor="#EEEEEE" creationComplete="setup()" width="100%" height="100%" horizontalAlign="center"
        verticalAlign="middle">
    <mx:Metadata>
        [Event(name="loginEvent2", type="com.easyinsight.framework.LoginEvent")]
        [Event(name="quietLogin", type="com.easyinsight.framework.LoginEvent")]
        [Event(name="connectionGo", type="com.easyinsight.framework.ConnectionGoEvent")]
        [Event(name="allDone", type="flash.events.Event")]
    </mx:Metadata>
    <mx:Script><![CDATA[
        import com.easyinsight.account.Account;
        import com.easyinsight.account.AccountSetupData;
        import com.easyinsight.customupload.ConnectionInstall;
        import com.easyinsight.customupload.DataSourceConfiguredEvent;
        import com.easyinsight.preferences.Persona;
        import com.easyinsight.quicksearch.EIDescriptor;
        import com.easyinsight.solutions.DataSourceDescriptor;
        import com.easyinsight.solutions.PostInstallSource;
        import com.easyinsight.solutions.Solution;
        import com.easyinsight.solutions.SolutionInstallInfo;
        import com.easyinsight.util.CookieUtil;
        import com.easyinsight.util.ProgressAlert;

        import mx.collections.ArrayCollection;
        import mx.effects.Effect;
        import mx.messaging.config.ServerConfig;

        [Bindable]
        private var panelIndex:int;

        private var _solutionID:String;

        [Bindable(event="solutionIDChanged")]
        public function get solutionID():String {
            return _solutionID;
        }

        public function set solutionID(value:String):void {
            if (_solutionID == value) return;
            _solutionID = value;
            dispatchEvent(new Event("solutionIDChanged"));
        }

        private function setup():void {
            if (_initState == 1) {
                panelIndex = 3;
            } else if (_initState == 2) {
                panelIndex = 6;
            } else if (_initState == 3) {
                panelIndex = 4;
            } else {
                loginComponent.setupFocus();
            }
        }

        private var _configureInline:Boolean;

        public function set configureInline(value:Boolean):void {
            _configureInline = value;
        }

        [Bindable]
        private var setupData:AccountSetupData = new AccountSetupData();

        private function gotSolution():void {
            solution = solutionService.retrieveSolution.lastResult as Solution;
            solutionService.installSolution.send(int(_solutionID));
        }

        private var solution:Solution;

        private function installed():void {
            installResult = solutionService.installSolution.lastResult as ArrayCollection;
            for each (var solutionInstallInfo:SolutionInstallInfo in installResult) {
                if (solutionInstallInfo.descriptor.getType() == EIDescriptor.DATA_SOURCE && solutionInstallInfo.requiresConfiguration) {
                    var configWindow:ConnectionInstall = new ConnectionInstall();
                    configWindow.dataSourceID = solutionInstallInfo.descriptor.id;
                    configWindow.percentHeight = 100;
                    configWindow.percentWidth = 100;
                    configWindow.onlyDataSource = true;
                    configWindow.addEventListener(DataSourceConfiguredEvent.DATA_SOURCE_CONFIGURED, onSourceConfigured, false, 0, true);
                    configWindow.addEventListener("later", onLater, false, 0, true);
                    removeChild(viewStack);
                    addChild(configWindow);
                }
            }
        }

        private function onLater(event:Event):void {
            dispatchEvent(new Event("allDone"));
        }

        private var installResult:ArrayCollection;

        private function onSourceConfigured(event:DataSourceConfiguredEvent):void {

            var dataSourceItems:ArrayCollection = new ArrayCollection();

            for each (var solInstall:SolutionInstallInfo in installResult) {
                if (solInstall.descriptor.getType() == EIDescriptor.DATA_SOURCE) {
                    dataSourceItems.addItem(solInstall.descriptor);
                }
            }
            var dataSource:DataSourceDescriptor = dataSourceItems.getItemAt(0) as DataSourceDescriptor;
            dispatchEvent(new ConnectionGoEvent(new PostInstallSource(dataSource, solution)));
        }

        private function accountCreated(event:LoginEvent):void {
            dispatchEvent(new LoginEvent(LoginEvent.QUIET_LOGIN, event.authResponse));
            panelIndex++;
        }

        private function remaining():void {
            panelIndex++;
        }

        private function finishAccountSetup():void {
            userService.applySetupData.send(setupData);
        }

        private function applied():void {
            User.getInstance().changeSettings(Persona(setupData.personas.getItemAt(setupData.myPersona)).uiSettings);
            if (accountType >= _requiredTier && int(_solutionID) > 0 && _configureInline) {
                ProgressAlert.alert(this, "Establishing connection...", null, solutionService.retrieveSolution, solutionService.installSolution);
                solutionService.retrieveSolution.send(int(_solutionID));
            } else {
                dispatchEvent(new Event("allDone"));
            }
        }

        [Bindable]
        private var accountType:int;

        private var _requiredTier:int;


        [Bindable(event="requiredTierChanged")]
        public function get requiredTier():int {
            return _requiredTier;
        }

        public function set requiredTier(value:int):void {
            if (_requiredTier == value) return;
            _requiredTier = value;
            dispatchEvent(new Event("requiredTierChanged"));
        }

        private function toBilling():void {
            navigateToURL(new URLRequest('billing/billing.jsp'), '_self');
        }

        private function loginHandler(event:LoginEvent):void {
            if (event.authResponse.accountState == Account.DELINQUENT) {
                panelIndex = 3;
            } else if (event.authResponse.accountState == Account.REACTIVATION_POSSIBLE) {
                panelIndex = 6;
                dispatchEvent(new LoginEvent(LoginEvent.QUIET_LOGIN, event.authResponse));
            } else if (event.authResponse.accountState == Account.INACTIVE) {
                panelIndex = 4;
            } else {
                dispatchEvent(event);
            }
        }

        private var _initState:int;


        public function set initState(value:int):void {
            _initState = value;
        }

        private function reactivate():void {
            userService.reactivate.send();
        }

        private function reactivated():void {
            panelIndex++;
        }

        private function onward():void {
            dispatchEvent(new Event("allDone"));
        }

        [Bindable]
        private var slideEffect:Effect = rightEffect;

        private function resendActivationEmail():void {
            ProgressAlert.alert(this, "Resending activation email...", null, userService.resendActivationEmail);
            userService.resendActivationEmail.send();
        }

        private function resent():void {
            panelIndex++;
        }

        private function logout():void {
            CookieUtil.deleteCookie("eisession");
            ServerConfig.getChannelSet(userService.destination).logout();
            panelIndex = 0;
            loginComponent.setupFocus();
        }

        [Bindable]
        [Embed(source="../../../../assets/logo2.PNG")]
        private var logo:Class;

        [Bindable]
        [Embed(source="../../../../assets/mailx48.png")]
        private var mailIcon:Class;

        [Bindable]
        [Embed(source="../../../../assets/chart_pie2_48x48.png")]
        public var connectionsIcon:Class;

        [Bindable]
        [Embed(source="../../../../assets/credit_card_x48.png")]
        public var moneyIcon:Class;
        ]]></mx:Script>
    <viewStackEffects:Slide id="leftEffect" direction="right"/>
    <viewStackEffects:Slide id="rightEffect" direction="left"/>

    <mx:RemoteObject destination="solutionService" id="solutionService">
        <mx:method name="installSolution" result="installed()"/>
        <mx:method name="retrieveSolution" result="gotSolution()"/>
    </mx:RemoteObject>
    <mx:RemoteObject destination="login" id="userService">
        <mx:method name="applySetupData" result="applied()"/>
        <mx:method name="reactivate" result="reactivated()"/>
        <mx:method name="resendActivationEmail" result="resent()"/>
    </mx:RemoteObject>


    <mx:ViewStack selectedIndex="{panelIndex}"
                  id="viewStack" resizeToContent="true"
                  paddingTop="10">
        <mx:HBox width="100%" verticalAlign="middle" height="100%" hideEffect="{slideEffect}"
                 showEffect="{slideEffect}">
            <!-- login page -->
            <framework:LoginComponent loginEvent2="loginHandler(event)" id="loginComponent"
                                      y="114"/>
        </mx:HBox>
        <mx:VBox hideEffect="{slideEffect}" showEffect="{slideEffect}">
            <account:DefaultPersonaPanel id="personaPanel" setupData="{setupData}"
                                         kpiTutorialNext="slideEffect = rightEffect; remaining()"
                                         accountType="{accountType}"/>
        </mx:VBox>
        <mx:VBox hideEffect="{slideEffect}" showEffect="{slideEffect}">
            <account:InitialPreferences id="preferencesPanel" setupData="{setupData}"
                                        kpiTutorialFinish="finishAccountSetup()" accountType="{accountType}"/>
        </mx:VBox>

        <!--
            additional emails
        -->

        <!-- welcome back panel -->
        <mx:Box paddingBottom="10" paddingLeft="10" paddingRight="10" paddingTop="10">
            <mx:VBox horizontalAlign="center" verticalAlign="middle"
                     hideEffect="{slideEffect}" showEffect="{slideEffect}" paddingTop="10" paddingBottom="10"
                     paddingLeft="10" paddingRight="10" cornerRadius="10"
                     borderColor="#DDDDDD" dropShadowEnabled="true" borderStyle="solid" backgroundColor="#FFFFFF">
                <mx:Image source="{moneyIcon}"/>
                <mx:TextArea borderStyle="none" editable="false" selectable="false" backgroundAlpha="0"
                             fontSize="18"
                             text="Your trial has expired. You'll need to enter billing information to continue using Easy Insight."
                             width="350" height="80"/>
                <mx:HBox width="100%" horizontalAlign="center">
                    <mx:Button label="Enter Billing" click="toBilling()" fontSize="18" styleName="grayButton"/>
                    <mx:Button label="Log Out" click="logout()" fontSize="18" styleName="grayButton"/>
                </mx:HBox>
            </mx:VBox>
        </mx:Box>
        <mx:Box paddingBottom="10" paddingLeft="10" paddingRight="10" paddingTop="10">
            <mx:VBox horizontalAlign="center" verticalAlign="middle"
                     hideEffect="{slideEffect}" showEffect="{slideEffect}" paddingTop="10" paddingBottom="10"
                     paddingLeft="10" paddingRight="10" cornerRadius="10"
                     borderColor="#DDDDDD" dropShadowEnabled="true" borderStyle="solid" backgroundColor="#FFFFFF"
                     borderThickness="1">
                <mx:Image source="{mailIcon}"/>
                <mx:TextArea borderStyle="none" editable="false" selectable="false" backgroundAlpha="0"
                             fontSize="18"
                             text="You haven't activated your account yet. Need a new activation email?"
                             width="350" height="80"/>
                <mx:HBox width="100%" horizontalAlign="center">
                    <mx:Button label="Resend Activation Email" click="resendActivationEmail()" fontSize="18"
                           styleName="grayButton"/>
                    <mx:Button label="Log Out" click="logout()" fontSize="18" styleName="grayButton"/>
                </mx:HBox>
            </mx:VBox>
        </mx:Box>
        <mx:Box paddingBottom="10" paddingLeft="10" paddingRight="10" paddingTop="10">
            <mx:VBox horizontalAlign="center" verticalAlign="middle"
                     hideEffect="{slideEffect}" showEffect="{slideEffect}" paddingTop="10" paddingBottom="10"
                     paddingLeft="10" paddingRight="10" cornerRadius="10"
                     borderColor="#DDDDDD" dropShadowEnabled="true" borderStyle="solid" backgroundColor="#FFFFFF">
                <mx:Image source="{mailIcon}"/>
                <mx:TextArea borderStyle="none" editable="false" selectable="false" backgroundAlpha="0"
                             fontSize="18"
                             text="You should've received a new email. Click on the link in that email to activate your account."
                             width="350" height="80"/>
                <mx:Button label="Log Out" click="logout()" fontSize="18" styleName="grayButton"/>
            </mx:VBox>
        </mx:Box>
        <!-- delinquent panel -->
        <mx:Box paddingBottom="10" paddingLeft="10" paddingRight="10" paddingTop="10">
            <mx:VBox horizontalAlign="center" verticalAlign="middle"
                     hideEffect="{slideEffect}" showEffect="{slideEffect}" paddingTop="10" paddingBottom="10"
                     paddingLeft="10" paddingRight="10" cornerRadius="10"
                     borderColor="#DDDDDD" dropShadowEnabled="true" borderStyle="solid" backgroundColor="#FFFFFF">
                <mx:Image source="{connectionsIcon}"/>
                <mx:Label text="Ready to give Easy Insight another try?" fontSize="18"/>
                <mx:TextArea borderStyle="none" editable="false" selectable="false" backgroundAlpha="0"
                             fontSize="18"
                             text="When you reactivate your account, you'll receive a fresh 30 day trial."
                             width="350" height="80" textAlign="center"/>
                <mx:Button label="Reactivate" click="reactivate()" fontSize="18"/>
            </mx:VBox>
        </mx:Box>
        <mx:Box paddingBottom="10" paddingLeft="10" paddingRight="10" paddingTop="10">
            <mx:VBox horizontalAlign="center" verticalAlign="middle"
                     hideEffect="{slideEffect}" showEffect="{slideEffect}" paddingTop="10" paddingBottom="10"
                     paddingLeft="10" paddingRight="10" cornerRadius="10"
                     borderColor="#DDDDDD" dropShadowEnabled="true" borderStyle="solid" backgroundColor="#FFFFFF">
                <mx:Image source="{connectionsIcon}"/>
                <mx:Label text="Your account is now active again with a new 30 day trial!" fontSize="20"/>
                <mx:Button label="Onward to the Application!" click="onward()" fontSize="18"/>
            </mx:VBox>
        </mx:Box>
    </mx:ViewStack>
</mx:Box>