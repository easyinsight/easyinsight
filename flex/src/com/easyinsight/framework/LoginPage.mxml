<?xml version="1.0" ?>
<mx:Box xmlns:mx="http://www.adobe.com/2006/mxml" 
        xmlns:framework="com.easyinsight.framework.*" xmlns:account="com.easyinsight.account.*"
        backgroundColor="#EEEEEE" creationComplete="setup()" width="100%" height="100%" horizontalAlign="center"
        verticalAlign="middle">
    <mx:Metadata>
        [Event(name="loginEvent2", type="com.easyinsight.framework.LoginEvent")]
        [Event(name="quietLogin", type="com.easyinsight.framework.LoginEvent")]
        [Event(name="connectionGo", type="com.easyinsight.framework.ConnectionGoEvent")]
        [Event(name="allDone", type="flash.events.Event")]
    </mx:Metadata>
    <mx:Script><![CDATA[
        import com.easyinsight.account.Account;
        import com.easyinsight.account.AccountSetupData;
        import com.easyinsight.preferences.Persona;
        import com.easyinsight.util.CookieUtil;
        import com.easyinsight.util.ProgressAlert;

        import mx.collections.ArrayCollection;        
        import mx.messaging.config.ServerConfig;

        public static const DELINQUENT:int = 1;
        public static const REACTIVATE:int = 2;
        public static const INITIAL_ADMIN_SETUP:int = 3;
        public static const NEEDS_ACTIVATION:int = 4;
        public static const INITIAL_USER_SETUP:int = 5;

        [Bindable]
        private var panelIndex:int;

        private function setup():void {
            if (_initState == DELINQUENT) {
                panelIndex = 3;
            } else if (_initState == REACTIVATE) {
                panelIndex = 6;
            } else if (_initState == NEEDS_ACTIVATION) {
                panelIndex = 4;
            } else if (_initState == INITIAL_ADMIN_SETUP) {
                panelIndex = 1;
            } else if (_initState == INITIAL_USER_SETUP) {
                panelIndex = 8;
            } else {
                loginComponent.setupFocus();
            }
        }

        [Bindable]
        private var setupData:AccountSetupData = new AccountSetupData();

        private function onLater(event:Event):void {
            dispatchEvent(new Event("allDone"));
        }

        private var installResult:ArrayCollection;

        private function accountCreated(event:LoginEvent):void {
            dispatchEvent(new LoginEvent(LoginEvent.QUIET_LOGIN, event.authResponse));
            panelIndex++;
        }

        private function remaining():void {
            panelIndex++;
        }

        private function finishAccountSetup():void {
            ProgressAlert.alert(this, "Applying setup data...", null, userService.applySetupData);
            userService.applySetupData.send(setupData);
        }

        private function applied():void {
            User.getInstance().changeSettings(Persona(setupData.personas.getItemAt(setupData.myPersona)).uiSettings);
            dispatchEvent(new Event("allDone"));            
        }

        [Bindable]
        private var accountType:int;

        private function toBilling():void {
            navigateToURL(new URLRequest('billing/billing.jsp'), '_self');
        }

        private function loginHandler(event:LoginEvent):void {
            if (event.authResponse.accountState == Account.DELINQUENT) {
                panelIndex = 3;
            } else if (event.authResponse.accountState == Account.REACTIVATION_POSSIBLE) {
                panelIndex = 6;
                dispatchEvent(new LoginEvent(LoginEvent.QUIET_LOGIN, event.authResponse));
            } else if (event.authResponse.accountState == Account.INACTIVE) {
                panelIndex = 4;
            } else if (event.authResponse.firstLogin && event.authResponse.accountAdmin) {
                dispatchEvent(new LoginEvent(LoginEvent.QUIET_LOGIN, event.authResponse));
                panelIndex = 1;
            } else if (event.authResponse.firstLogin && !event.authResponse.accountAdmin) {
                dispatchEvent(new LoginEvent(LoginEvent.QUIET_LOGIN, event.authResponse));
                panelIndex = 8;
            } else {
                dispatchEvent(event);
            }
        }

        private var _initState:int;


        public function set initState(value:int):void {
            _initState = value;
        }

        private function reactivate():void {
            userService.reactivate.send();
        }

        private function reactivated():void {
            panelIndex++;
        }

        private function onward():void {
            dispatchEvent(new Event("allDone"));
        }

        private function resendActivationEmail():void {
            ProgressAlert.alert(this, "Resending activation email...", null, userService.resendActivationEmail);
            userService.resendActivationEmail.send();
        }

        private function resent():void {
            panelIndex++;
        }

        private function logout():void {
            CookieUtil.deleteCookie("eisession");
            ServerConfig.getChannelSet(userService.destination).logout();
            panelIndex = 0;
            loginComponent.setupFocus();
        }

        [Bindable]
        [Embed(source="../../../../assets/logo2.PNG")]
        private var logo:Class;

        [Bindable]
        [Embed(source="../../../../assets/mailx48.png")]
        private var mailIcon:Class;

        [Bindable]
        [Embed(source="../../../../assets/chart_pie2_48x48.png")]
        public var connectionsIcon:Class;

        [Bindable]
        [Embed(source="../../../../assets/credit_card_x48.png")]
        public var moneyIcon:Class;
        ]]></mx:Script>
    <mx:RemoteObject destination="login" id="userService">
        <mx:method name="applySetupData" result="applied()"/>
        <mx:method name="reactivate" result="reactivated()"/>
        <mx:method name="resendActivationEmail" result="resent()"/>
    </mx:RemoteObject>


    <mx:ViewStack selectedIndex="{panelIndex}"
                  id="viewStack" resizeToContent="true"
                  paddingTop="10">

        <!-- 0, login page -->
        <mx:HBox width="100%" verticalAlign="middle" height="100%">
            <framework:LoginComponent loginEvent2="loginHandler(event)" id="loginComponent"
                                      y="114"/>
        </mx:HBox>

        <!-- 1, initial account creation -->
        <mx:Box paddingBottom="10" paddingLeft="10" paddingRight="10" paddingTop="10">
            <mx:VBox horizontalAlign="center" verticalAlign="middle"
                     paddingTop="10" paddingBottom="10"
                     paddingLeft="10" paddingRight="10" cornerRadius="10"
                     borderColor="#DDDDDD" dropShadowEnabled="true" borderStyle="solid" backgroundColor="#FFFFFF">
                <account:DefaultPersonaPanel id="personaPanel" setupData="{setupData}"
                                         kpiTutorialNext="remaining()"
                                         accountType="{accountType}"/>
            </mx:VBox>
        </mx:Box>
        <mx:Box paddingBottom="10" paddingLeft="10" paddingRight="10" paddingTop="10">
            <mx:VBox horizontalAlign="center" verticalAlign="middle"
                     paddingTop="10" paddingBottom="10"
                     paddingLeft="10" paddingRight="10" cornerRadius="10"
                     borderColor="#DDDDDD" dropShadowEnabled="true" borderStyle="solid" backgroundColor="#FFFFFF">
                <account:InitialPreferences id="preferencesPanel" setupData="{setupData}"
                                        kpiTutorialFinish="finishAccountSetup()" accountType="{accountType}"/>
            </mx:VBox>
        </mx:Box>

        <!-- 3, delinquent -->
        <mx:Box paddingBottom="10" paddingLeft="10" paddingRight="10" paddingTop="10">
            <mx:VBox horizontalAlign="center" verticalAlign="middle"
                     paddingTop="10" paddingBottom="10"
                     paddingLeft="10" paddingRight="10" cornerRadius="10"
                     borderColor="#DDDDDD" dropShadowEnabled="true" borderStyle="solid" backgroundColor="#FFFFFF">
                <mx:Image source="{moneyIcon}"/>
                <mx:TextArea borderStyle="none" editable="false" selectable="false" backgroundAlpha="0"
                             fontSize="18"
                             text="Your trial has expired. You'll need to enter billing information to continue using Easy Insight."
                             width="350" height="80"/>
                <mx:HBox width="100%" horizontalAlign="center">
                    <mx:Button label="Enter Billing" click="toBilling()" fontSize="18" styleName="grayButton"/>
                    <mx:Button label="Log Out" click="logout()" fontSize="18" styleName="grayButton"/>
                </mx:HBox>
            </mx:VBox>
        </mx:Box>

        <!-- 4, not activated yet -->
        <mx:Box paddingBottom="10" paddingLeft="10" paddingRight="10" paddingTop="10">
            <mx:VBox horizontalAlign="center" verticalAlign="middle"
                     paddingTop="10" paddingBottom="10"
                     paddingLeft="10" paddingRight="10" cornerRadius="10"
                     borderColor="#DDDDDD" dropShadowEnabled="true" borderStyle="solid" backgroundColor="#FFFFFF"
                     borderThickness="1">
                <mx:Image source="{mailIcon}"/>
                <mx:TextArea borderStyle="none" editable="false" selectable="false" backgroundAlpha="0"
                             fontSize="18"
                             text="You haven't activated your account yet. Need a new activation email?"
                             width="350" height="80"/>
                <mx:HBox width="100%" horizontalAlign="center">
                    <mx:Button label="Resend Activation Email" click="resendActivationEmail()" fontSize="18"
                           styleName="grayButton"/>
                    <mx:Button label="Log Out" click="logout()" fontSize="18" styleName="grayButton"/>
                </mx:HBox>
            </mx:VBox>
        </mx:Box>
        <mx:Box paddingBottom="10" paddingLeft="10" paddingRight="10" paddingTop="10">
            <mx:VBox horizontalAlign="center" verticalAlign="middle"
                     paddingTop="10" paddingBottom="10"
                     paddingLeft="10" paddingRight="10" cornerRadius="10"
                     borderColor="#DDDDDD" dropShadowEnabled="true" borderStyle="solid" backgroundColor="#FFFFFF">
                <mx:Image source="{mailIcon}"/>
                <mx:TextArea borderStyle="none" editable="false" selectable="false" backgroundAlpha="0"
                             fontSize="18"
                             text="You should've received a new email. Click on the link in that email to activate your account."
                             width="350" height="80"/>
                <mx:Button label="Log Out" click="logout()" fontSize="18" styleName="grayButton"/>
            </mx:VBox>
        </mx:Box>

        <!-- 6, reactivate -->
        <mx:Box paddingBottom="10" paddingLeft="10" paddingRight="10" paddingTop="10">
            <mx:VBox horizontalAlign="center" verticalAlign="middle"
                     paddingTop="10" paddingBottom="10"
                     paddingLeft="10" paddingRight="10" cornerRadius="10"
                     borderColor="#DDDDDD" dropShadowEnabled="true" borderStyle="solid" backgroundColor="#FFFFFF">
                <mx:Image source="{connectionsIcon}"/>
                <mx:Label text="Ready to give Easy Insight another try?" fontSize="18"/>
                <mx:TextArea borderStyle="none" editable="false" selectable="false" backgroundAlpha="0"
                             fontSize="18"
                             text="When you reactivate your account, you'll receive a fresh 30 day trial."
                             width="350" height="80" textAlign="center"/>
                <mx:Button label="Reactivate" click="reactivate()" fontSize="18"/>
            </mx:VBox>
        </mx:Box>
        <mx:Box paddingBottom="10" paddingLeft="10" paddingRight="10" paddingTop="10">
            <mx:VBox horizontalAlign="center" verticalAlign="middle"
                     paddingTop="10" paddingBottom="10"
                     paddingLeft="10" paddingRight="10" cornerRadius="10"
                     borderColor="#DDDDDD" dropShadowEnabled="true" borderStyle="solid" backgroundColor="#FFFFFF">
                <mx:Image source="{connectionsIcon}"/>
                <mx:Label text="Your account is now active again with a new 30 day trial!" fontSize="20"/>
                <mx:Button label="Onward to the Application!" click="onward()" fontSize="18"/>
            </mx:VBox>
        </mx:Box>

        <!-- 8, initial user creation -->
        <mx:Box paddingBottom="10" paddingLeft="10" paddingRight="10" paddingTop="10">
            <mx:VBox horizontalAlign="center" verticalAlign="middle"
                     paddingTop="10" paddingBottom="10"
                     paddingLeft="10" paddingRight="10" cornerRadius="10"
                     borderColor="#DDDDDD" dropShadowEnabled="true" borderStyle="solid" backgroundColor="#FFFFFF">
                <framework:InitialLoginWindow kpiTutorialNext="dispatchEvent(new Event('allDone'));"/>
            </mx:VBox>
        </mx:Box>
    </mx:ViewStack>
</mx:Box>