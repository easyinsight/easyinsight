<?xml version="1.0" ?>
<mx:Box xmlns:mx="http://www.adobe.com/2006/mxml"
        creationComplete="addEventListener(KeyboardEvent.KEY_UP, keyedSignon); focusManager.setFocus(userName)"
         backgroundImage="{background2}" backgroundSize="100%">
    <mx:Metadata>
        [Event(name="loginEvent2", type="com.easyinsight.framework.LoginEvent")]
        [Event(name="loginClose", type="flash.events.Event")]
    </mx:Metadata>
    <mx:states>
        <mx:State name="ResetPassword" enterState="enterPasswordResetStateChange()" exitState="exitPasswordResetStateChange()">
            <mx:RemoveChild target="{loginForm}"/>
            <mx:AddChild relativeTo="{coreBox}">
                <mx:Form>
                    <mx:FormItem label="Email Address:" direction="horizontal">
                        <mx:TextInput id="emailAddressInput"/>
                        <mx:Label text="{emailFailure}" visible="{emailFailure != null}"/>
                    </mx:FormItem>
                    <mx:FormItem label="">
                        <mx:Button label="Reset Password" click="resetPassword()"/>
                    </mx:FormItem>
                    <mx:FormItem label="">
                        <mx:Button label="Back to Login" click="currentState=''"/>
                        <mx:Button label="Cancel" click="cancel()" visible="{_cancelVisible}"/>
                    </mx:FormItem>
                </mx:Form>
            </mx:AddChild>
        </mx:State>
        <mx:State name="PasswordReset">
            <mx:AddChild relativeTo="{activationBox}">
                <mx:Label text="An email has been sent to your email address to allow you to reset your password."/>
            </mx:AddChild>
        </mx:State>
        <mx:State name="UserNameReminded">
            <mx:AddChild relativeTo="{activationBox}">
                <mx:Label text="Your user name has been sent to your email address."/>
            </mx:AddChild>
        </mx:State>
        <mx:State name="AdditionalInfo">
            <mx:AddChild relativeTo="{activationBox}">
                <mx:Label text="{_additionalInfo}"/>
            </mx:AddChild>
        </mx:State>
        <mx:State name="Activated">
            <mx:RemoveChild target="{noAccount}"/>
            <mx:AddChild relativeTo="{activationBox}">
                <mx:Label text="Your account has been activated! You can now log in: " fontSize="14"/>
            </mx:AddChild>
        </mx:State>
    </mx:states>
    <mx:Script>
		<![CDATA[
        import mx.messaging.config.ServerConfig;
        import mx.rpc.AsyncResponder;
        import mx.rpc.AsyncToken;
        import mx.rpc.events.FaultEvent;
        import mx.rpc.events.ResultEvent;

        private function passwordResetEnter(event:KeyboardEvent):void {
            if (event.keyCode == Keyboard.ENTER) {
                resetPassword();
            }
        }

        private function exitPasswordResetStateChange():void {
            this.removeEventListener(KeyboardEvent.KEY_UP, passwordResetEnter);
            this.addEventListener(KeyboardEvent.KEY_UP, keyedSignon);
        }

        private function enterPasswordResetStateChange():void {
            this.removeEventListener(KeyboardEvent.KEY_UP, keyedSignon);
            this.addEventListener(KeyboardEvent.KEY_UP, passwordResetEnter);
        }

        [Bindable]
        private var _additionalInfo:String;

        [Bindable]
        private var _cancelVisible:Boolean;

        private var _showActivation:Boolean;

        private var _newAccount:Boolean;


        public function get newAccount():Boolean {
            return _newAccount;
        }

        public function set newAccount(value:Boolean):void {
            _newAccount = value;
        }

        [Bindable]
        private var resetResult:String;

        [Bindable]
        private var _targetURL:String;

        [Bindable]
        private var emailFailure:String;


        public function set targetURL(value:String):void {
            _targetURL = value;
        }

        public function set additionalInfo(value:String):void {
            _additionalInfo = value;
        }

        private function delinquentAccount():void {
            var delinquent:Boolean = authService.isAccountDelinquentOrClosed.lastResult as Boolean;
            if (delinquent)
                navigateToURL(new URLRequest("billing/login.jsp"), "_self");
        }

        private function toBaseState():void {
            if (_additionalInfo == null) {
                currentState = "";
            } else {
                currentState = "AdditionalInfo";
            }
        }

        [Bindable]
        [Embed(source="../../../../assets/background2.JPG")]
        private var background2:Class;

        public function set cancelVisible(value:Boolean):void {
            _cancelVisible = value;
        }

        public function set showActivation(val:Boolean):void {
            _showActivation = val;
            invalidateProperties();
        }

        private function resetPassword():void {
            authService.remindPassword.send(emailAddressInput.text);
        }

        private function reset():void {
            var result:Boolean = authService.remindPassword.lastResult as Boolean;
            if (result) {
                currentState = "PasswordReset";
            } else {
                emailFailure = "No such email address was found in Easy Insight.";
            }
        }

        private function remindedUserName():void {
            var result:Boolean = authService.remindUserName.lastResult as Boolean;
            if (result) {
                currentState = "UserNameReminded";
            } else {
                emailFailure = "No such email address was found in Easy Insight.";
            }
        }


        override protected function commitProperties():void {
            super.commitProperties();
            if (_showActivation) {
                currentState = "Activated";
            }
        }

        private function handleAuthentication():void {
            var authResult:UserServiceResponse = authService.authenticate.lastResult as UserServiceResponse;
            var successful:Boolean = authResult.successful;
            if (successful) {
                if (authService.channelSet == null) {
                    authService.channelSet = ServerConfig.getChannelSet(authService.destination);
                }
                var token:AsyncToken = authService.channelSet.login(this.userNameStr, this.passwordStr);
                token.addResponder(new AsyncResponder(
                        function (event:ResultEvent, token:Object = null):void {
                            switch (event.result) {
                                case "success":
                                    User.initializeUser(authResult);
                                    User.getInstance().userName = authResult.userName;
                                    dispatchEvent(new LoginEvent(LoginEvent.LOGIN, _targetURL, _newAccount));
                                    User.getEventNotifier().dispatchEvent(new LoginEvent(LoginEvent.LOGIN, _targetURL, _newAccount));
                                    break;
                                default:
                                    trace(event.result);
                            }
                        },
                        function (event:FaultEvent, token:Object = null):void {
                            switch (event.fault.faultCode) {
                                case "Client.Authentication":
                                default:
                                    failureMessage = event.fault.faultString;
                                /*if (failureMessageLabel != null)
                                 failureMessageLabel.text = failureMessage;
                                 else
                                 Alert.show(failureMessage);
                                 authService.isAccountDelinquentOrClosed.send(userNameStr);*/
                            }
                        }
                        ));

            } else {
                stackIndex = 0;
                failureMessage = authResult.failureMessage;
                authService.isAccountDelinquentOrClosed.send(userName.text);
            }
        }

        private var userNameStr:String;
        private var passwordStr:String;

        public function signon(userNameStr:String, passwordStr:String):void {
            stackIndex = 1;
            this.userNameStr = userNameStr;
            this.passwordStr = passwordStr;
            authService.authenticate.send(this.userNameStr, this.passwordStr);


        }

        private function cancel():void {
            dispatchEvent(new Event("loginClose"));
        }

        private function keyedSignon(event:KeyboardEvent):void {
            if (event.keyCode == Keyboard.ENTER) {
                signon(userName.text, password.text);
            }
        }

        private function createNewAccount():void {
            User.getEventNotifier().dispatchEvent(new NavigationEvent(NavigationEvent.ACCOUNTS));
            dispatchEvent(new Event("loginClose"));
        }

        [Bindable]
        private var failureMessage:String = "";

        [Bindable]
        private var stackIndex:int;
                ]]>
	</mx:Script>
    <mx:VBox id="coreBox" paddingTop="10" paddingBottom="10" paddingLeft="10" paddingRight="10">

        <mx:Box id="activationBox" width="100%" horizontalAlign="center" paddingTop="10"/>
        <mx:VBox id="loginForm" paddingLeft="0" paddingRight="0" paddingTop="0" paddingBottom="0">
        <mx:ViewStack selectedIndex="{stackIndex}">
            <mx:Form paddingBottom="0" paddingLeft="0" paddingRight="0" paddingTop="0">
                <mx:FormItem label="User Name or Email:" direction="horizontal">
                    <mx:TextInput id="userName" tabIndex="1"/>
                    <!--<mx:LinkButton fontSize="10" textDecoration="underline" label="Forgot your User Name?"
                                   click="currentState='RemindUserName'"/>-->
                </mx:FormItem>
                <mx:FormItem label="Password:" direction="horizontal">
                    <mx:TextInput id="password" displayAsPassword="true" tabIndex="2"/>
                    <mx:LinkButton fontSize="10" textDecoration="underline" label="Forgot your Password?"
                                   click="currentState='ResetPassword'"/>
                </mx:FormItem>
            </mx:Form>
            <mx:Box width="100%" height="100%" horizontalAlign="center" verticalAlign="middle">
                <mx:ProgressBar label="Connecting..." indeterminate="true"/>
            </mx:Box>
        </mx:ViewStack>
        <mx:Spacer height="10"/>
        <mx:HBox width="100%" horizontalAlign="center">
            <mx:Button label="Sign In" click="signon(userName.text, password.text)" tabIndex="3"/>
            <mx:Button label="Cancel" click="cancel()" visible="{_cancelVisible}" tabIndex="4"/>
        </mx:HBox>
        <mx:Spacer height="10"/>
        <mx:HBox>
            <mx:Label text="Don't have an account yet?" id="noAccount"/>
            <mx:Button label="Create Account" click="createNewAccount()"/>
        </mx:HBox>
        </mx:VBox>
        <mx:Spacer height="10"/>
        <mx:HBox width="100%" horizontalAlign="center">
            <mx:Text text="{failureMessage}" fontSize="14"/>
        </mx:HBox>
    </mx:VBox>
    <mx:RemoteObject id="authService" destination="login">
        <mx:method name="authenticate" result="handleAuthentication()"/>
        <mx:method name="remindPassword" result="reset()"/>
        <mx:method name="remindUserName" result="remindedUserName()"/>
        <mx:method name="isAccountDelinquentOrClosed" result="delinquentAccount()" />
    </mx:RemoteObject>
</mx:Box>