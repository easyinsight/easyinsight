<?xml version="1.0"?>
<mx:AdvancedDataGrid xmlns:mx="http://www.adobe.com/2006/mxml"
        rowHeight="24" fontSize="14" headerColors="{[0x333333, 0x333333]}" headerStyleName="WhiteHeader"
                iconColor="#FFFFFF" selectable="false" horizontalScrollPolicy="off" verticalScrollPolicy="off">
    <mx:Script><![CDATA[
        import com.easyinsight.analysis.AnalysisDefinition;
        import com.easyinsight.analysis.AnalysisItem;
        import com.easyinsight.analysis.TrendOutcome;
        import com.easyinsight.analysis.Value;
        import com.easyinsight.analysis.verticallist.VerticalListHeaderRenderer;

        import mx.collections.ArrayCollection;
        import mx.collections.Sort;
        import mx.collections.SortField;
        import mx.controls.advancedDataGridClasses.AdvancedDataGridColumn;
        import mx.controls.advancedDataGridClasses.SortInfo;

        private var firstLoad:Boolean = true;

        private var trend:TrendGridDefinition;

        public function renderReport(dataSet:ArrayCollection, analysisDefinition:AnalysisDefinition):void {
            if (dataSet.length > 0) {
                var trendDef:TrendGridDefinition = analysisDefinition as TrendGridDefinition;
                this.trend = trendDef;
                previousText = trendDef.dayWindow + " days ago";
                var trends:ArrayCollection = new ArrayCollection();
                var columns:Array = [];
                var maxGroupingSize:int = 0;
                var tGrouping:AnalysisItem = null;
                if (trendDef.groupings.length > 0) {
                    tGrouping = trendDef.groupings.getItemAt(0) as AnalysisItem;
                }
                for (var i:int = 0; i < dataSet.length; i++) {
                    var trendOutcome:TrendOutcome = dataSet.getItemAt(i) as TrendOutcome;
                    if (tGrouping != null) {
                        var val:Value = trendOutcome.dimensions[tGrouping.qualifiedName()];
                        maxGroupingSize = Math.max(maxGroupingSize, measureText(val.toString()).width);
                    }
                    trendOutcome.dataSourceID = trendDef.dataFeedID;
                    trendOutcome.report = trendDef;
                    trends.addItem(trendOutcome);
                }

                maxGroupingSize = Math.min(maxGroupingSize, 300);
                maxGroupingSize += 10;
                for each (var grouping:AnalysisItem in trendDef.groupings) {
                    var column:AdvancedDataGridColumn = new AdvancedDataGridColumn();
                    var groupFactory:ClassFactory = new ClassFactory(TrendGroupingRenderer);
                    groupFactory.properties = { grouping: grouping };
                    column.itemRenderer = groupFactory;
                    column.sortable = false;
                    column.width = maxGroupingSize;
                    column.headerRenderer = new ClassFactory(TrendHeaderRenderer);
                    column.headerText = grouping.display;
                    columns.push(column);
                }
                columns = columns.concat(defaultColumns.toArray());
                if (firstLoad) {
                    myDataSet = trends;
                    if (trend.sortIndex > -1) {
                        var existingSort:Sort = new Sort();
                        var numeric:Boolean = false;
                        var dataField:String = AdvancedDataGridColumn(columns[trend.sortIndex]).dataField;
                        if (dataField == "nowValue" || dataField == "historicalValue" || dataField == "percentChange") {
                            numeric = true;
                        }
                        existingSort.fields = [ new SortField(dataField, true, !trend.sortAscending, numeric) ];
                        trends.sort = existingSort;
                        trends.refresh();
                    }
                    firstLoad = false;
                } else {
                    var sort:Sort = myDataSet.sort;
                    myDataSet = trends;
                    myDataSet.sort = sort;
                    myDataSet.refresh();
                }
                this.columns = columns;
                this.dataProvider = trends;
                this.height = trends.length * this.rowHeight + 6 + this.headerHeight;
            }
        }

        private var myDataSet:ArrayCollection;

        [Bindable]
        private var previousText:String;

        public function updateExportMetadata():void {
            var sortSet:Boolean = false;
            for (var i:int = 0; i < columns.length; i++) {
                var column:AdvancedDataGridColumn = columns[i];
                var sortInfo:SortInfo = getFieldSortInfo(column);
                if (sortInfo != null && sortInfo.status == SortInfo.ACTUALSORT) {
                    if (sortInfo.sequenceNumber == 1) {
                        sortSet = true;
                        trend.sortIndex = i;
                        trend.sortAscending = !sortInfo.descending;
                    }
                }
            }
            if (!sortSet) {
                trend.sortIndex = -1;
            }
        }
        ]]></mx:Script>
    <mx:ArrayCollection id="defaultColumns">
        <mx:AdvancedDataGridColumn headerText="" dataField="name"
                               itemRenderer="com.easyinsight.analysis.trend.TrendStatusRenderer"
                               sortable="false" width="40"
                headerRenderer="com.easyinsight.analysis.verticallist.VerticalListHeaderRenderer"/>
        <mx:AdvancedDataGridColumn headerText="KPI Name" dataField="name" itemRenderer="com.easyinsight.analysis.trend.TrendNameRenderer" width="300"/>
        <mx:AdvancedDataGridColumn headerText="Latest" dataField="nowValue"
                               itemRenderer="com.easyinsight.analysis.trend.TrendValueRenderer" width="120"/>
        <mx:AdvancedDataGridColumn headerText="{previousText}" dataField="historicalValue"
                               itemRenderer="com.easyinsight.analysis.trend.TrendHistoricalValueRenderer" width="120"/>
        <mx:AdvancedDataGridColumn headerText="% Change" dataField="percentChange"
                               itemRenderer="com.easyinsight.analysis.trend.TrendChangeRenderer" width="100"/>
    </mx:ArrayCollection>
</mx:AdvancedDataGrid>
