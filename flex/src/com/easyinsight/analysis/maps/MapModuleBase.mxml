<?xml version="1.0" ?>
<mx:Module xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:ilog="ilog.maps.*"
           xmlns:maps="com.easyinsight.analysis.maps.*"
           width="100%" height="100%"
           xmlns:analysis="com.easyinsight.analysis.*" xmlns:map="com.easyinsight.map.*"
           implements="com.easyinsight.analysis.IReportRenderer" removedFromStage="cleanup()" creationComplete="blah()">
    <mx:Script>
		<![CDATA[
        
        import com.easyinsight.analysis.AnalysisItem;
        import com.easyinsight.analysis.CustomChangeEvent;
        import com.easyinsight.analysis.ReportRendererEvent;
        import com.easyinsight.filtering.FilterRawData;

        import com.easyinsight.pseudocontext.PseudoContextWindow;

        import ilog.maps.MapBase;

        import com.easyinsight.analysis.conditions.ConditionRenderer;

        import ilog.maps.MapEvent;
        import ilog.maps.MapFeature;

        import com.easyinsight.map.util.MapLocationLookup;

        import com.easyinsight.analysis.AnalysisDefinition;

        import mx.collections.ArrayCollection;
        import mx.controls.Alert;
        import mx.controls.ToolTip;
        import mx.formatters.Formatter;
        import mx.managers.PopUpManager;
        import mx.managers.ToolTipManager;

        [Bindable]
        private var tooltipFeature:String = "";

        private function blah():void {
            tooltip = ToolTipManager.createToolTip("", 0, 0, null) as ToolTip;
            tooltip.visible = false;
        }

        private function onMouseOut(event:MouseEvent):void {
            tooltip.visible = false;
        }

        private function cleanup():void {
            if (tooltip != null) {
                ToolTipManager.destroyToolTip(tooltip);                
            }
        }

        private var tooltip:ToolTip;

        public function onover(event:MapEvent):void {
            if (event.mapFeature != null) {
                var mf:MapFeature = event.mapFeature;
                tooltipFeature += mf.key;
                var point:Point = mf.mapBarycenter;
                var canvasPoint:Point = map.drawingCanvas.localToGlobal(point);
                tooltip.text = mf.data.label + " - " + mf.data.data;
                tooltip.x = canvasPoint.x;
                tooltip.y = canvasPoint.y;
                tooltip.visible = true;
            }
        }

        public function onout(event:MapEvent):void {
            tooltip.visible = false;
        }

        protected function onClick(event:MouseEvent):void {
            if (dimension != null && event.shiftKey) {
                var feature:MapFeature = map.getFeatureAt(event.localX, event.localY);
                if (feature != null) {
                    var window:PseudoContextWindow = new PseudoContextWindow(dimension, passThrough, this);
                    window.data = feature.data;
                    PopUpManager.addPopUp(window, this);
                    window.x = event.stageX + 5;
                    window.y = event.stageY + 5;
                }
            }
        }

        protected function createMap():MapBase {
            return null;
        }

        private function passThrough(event:Event):void {
            dispatchEvent(event);
        }

        [Bindable]
        private var graphData:ArrayCollection = new ArrayCollection();

        private var masterDataSet:ArrayCollection = new ArrayCollection();

        private var map:MapBase;

        

        private var hasDropAreas:Boolean = true;

        private var dimension:AnalysisItem;

        [Bindable]
        private var conditionRenderer:ConditionRenderer;

        [Bindable]
        private var minValue:Number;

        [Bindable]
        private var maxValue:Number;

        [Bindable]
        private var formatter:Formatter;

        private function createRenderer(rows:ArrayCollection, mapDefinition:MapDefinition):ConditionRenderer {
            var renderer:ConditionRenderer = mapDefinition.measure.createClientRenderer();
            for (var i:int = 0; i < rows.length; i++) {
                var row:Object = rows.getItemAt(i);
                var values:Array = row.values as Array;
                var dimensionValue:String;
                var measureValue:Object;
                dimensionValue = row[mapDefinition.geography.qualifiedName()];
                measureValue = row[mapDefinition.measure.qualifiedName()];
                var location:String = MapLocationLookup.instance().getLocation(dimensionValue, String(mapType));
                if (location != null) {
                    renderer.addValue(measureValue);
                }
            }
            return renderer;
        }

        private function customChange(customChangeEvent:CustomChangeEvent, analysisDefinition:AnalysisDefinition):void {
            var mapTypeEvent:MapTypeEvent = customChangeEvent as MapTypeEvent;
            var mapDefinition:MapDefinition = analysisDefinition as MapDefinition;
            mapDefinition.mapType = mapTypeEvent.mapType;
            dispatchEvent(new ReportRendererEvent(ReportRendererEvent.FORCE_RENDER));
        }

        public function renderReport(dataSet:ArrayCollection, analysisDefinition:AnalysisDefinition, clientProcessorMap:Object):void {
            var mapDefinition:MapDefinition = analysisDefinition as MapDefinition;
            dimension = mapDefinition.geography;
            graphData = new ArrayCollection();            
            if (dataSet.length > 0) {
                this.formatter = mapDefinition.measure.getFormatter();
                var renderer:ConditionRenderer = createRenderer(dataSet, mapDefinition);
                this.conditionRenderer = renderer;
                this.minValue = Number.MAX_VALUE;
                this.maxValue = Number.MIN_VALUE;
                for (var i:int = 0; i < dataSet.length; i++) {
                    var row:Object = dataSet.getItemAt(i);
                    var dimensionValue:String = row[mapDefinition.geography.qualifiedName()];
                    var measureValue:Number = Number(row[mapDefinition.measure.qualifiedName()]);
                    this.minValue = Math.min(this.minValue, measureValue);
                    this.maxValue = Math.max(this.maxValue, measureValue);

                    var location:String = MapLocationLookup.instance().getLocation(dimensionValue, String(mapType));
                    if (location != null) {
                        var mapFeature:MapFeature = map.getFeature(location);
                        if (mapFeature != null) {
                            var dataObj:Object = new Object();
                            dataObj.label = dimensionValue;
                            dataObj.data = mapDefinition.measure.getFormatter().format(measureValue);
                            var color:uint = renderer.getColor(measureValue);
                            mapFeature.data = dataObj;
                            mapFeature.setStyle(MapBase.FILL, color);
                        }
                    }
                }
                if (minValue != Number.MAX_VALUE && maxValue != Number.MIN_VALUE) {
                    legend.recreate();
                }
            }
        }

        protected function get mapType():int {
            return 0;
        }

        public function createFilterRawData():FilterRawData {
            return null;
        }

        public function updateExportMetadata():void {
        }

        public function onCustomChangeEvent(event:CustomChangeEvent):void {
        }

        override protected function createChildren():void {
            super.createChildren();
            map = createMap();
            coreCanvas.addChild(map);
        }

		]]>
    </mx:Script>
    <mx:HBox id="chartVBox" width="100%" height="100%">
        <mx:Canvas id="coreCanvas" width="100%" height="100%">

        </mx:Canvas>
        <maps:ColorRangeLegend points="5" conditionRenderer="{conditionRenderer}" maxValue="{maxValue}" minValue="{minValue}"
                formatter="{formatter}" id="legend"/>
        
    </mx:HBox>
</mx:Module>