<?xml version="1.0" ?>
<mx:Module xmlns:mx="http://www.adobe.com/2006/mxml" implements="com.easyinsight.analysis.IReportRenderer"
        width="100%" height="100%">
    <mx:Script><![CDATA[

        import com.easyinsight.analysis.AnalysisDateDimension;
        import com.easyinsight.analysis.AnalysisDefinition;
        import com.easyinsight.analysis.AnalysisItem;
        import com.easyinsight.analysis.AnalysisItemTypes;
        import com.easyinsight.analysis.AnalysisMeasure;

        import com.easyinsight.analysis.CustomChangeEvent;
        import com.easyinsight.filtering.FilterRawData;

        import mx.charts.CategoryAxis;
        import mx.charts.DateTimeAxis;
        import mx.charts.HitData;
        import mx.charts.Legend;
        import mx.charts.LineChart;
        import mx.charts.chartClasses.IAxis;
        import mx.charts.series.LineSeries;
        import mx.charts.series.items.LineSeriesItem;
        import mx.collections.ArrayCollection;
        import mx.collections.Sort;
        import mx.collections.SortField;

        [Bindable]
        private var chartData:ArrayCollection;

        private var lineChart:LineChart;

        private var legend:Legend;

        private var xAxisItem:AnalysisItem;

        private var measureMap:Object = new Object();

        override protected function createChildren():void {
            super.createChildren();
            if (lineChart == null) {
                lineChart = new LineChart();
                lineChart.percentHeight = 100;
                lineChart.percentWidth = 100;
                //lineChart.dataProvider = chartData;
                lineChart.selectionMode = "multiple";
            }
            hbox.addChild(lineChart);
            if (legend == null) {
                legend = new Legend();
                legend.direction = "vertical";
                legend.percentHeight = 100;
            }
            hbox.addChild(legend);
        }

        private function dataTipFunction(hitData:HitData):String {
            var string:String;
            var lineSeries:LineSeries = hitData.element as LineSeries;
            var lineSeriesItem:LineSeriesItem = hitData.chartItem as LineSeriesItem;
            var measureItem:AnalysisMeasure = measureMap[lineSeries.yField] as AnalysisMeasure;
            string = lineSeries.displayName + "\n" +
                     xAxisItem.getFormatter().format(lineSeriesItem.xValue) + "\n" + measureItem.getFormatter().format(lineSeriesItem.yValue);
            return string;
        }

        public function renderReport(dataSet:ArrayCollection, analysisDefinition:AnalysisDefinition, clientProcessorMap:Object, additionalProperties:Object):void {

            var lineChartDef:MultiMeasureLineChartDefinition = analysisDefinition as MultiMeasureLineChartDefinition;

            this.chartData = new ArrayCollection(dataSet.toArray());

            hbox.removeChild(lineChart);

            lineChart = new LineChart();
            lineChart.percentHeight = 100;
            lineChart.percentWidth = 100;
            lineChart.dataProvider = chartData;
            lineChart.showDataTips = true;
            lineChart.selectionMode = "multiple";

            if (chartData.length > 0) {

                var xAxisDimension:AnalysisItem = lineChartDef.xaxis;

                var sort:Sort = new Sort();
                var sortField:SortField = new SortField(xAxisDimension.qualifiedName(), true);
                sort.fields = [ sortField ];
                if (chartData.length > 0) {
                    var firstObj:Object = chartData.getItemAt(0);
                    var firstVal:Object = firstObj[xAxisDimension.qualifiedName()];
                    if (firstVal is Number) {
                        sortField.numeric = true;
                    }

                    chartData.sort = sort;
                    chartData.refresh();

                    if (firstVal is Number) {
                        var categories:ArrayCollection = new ArrayCollection();
                        for each (var obj:Object in chartData) {
                            var valObj:Object = obj[xAxisDimension.qualifiedName()];
                            if (categories.getItemIndex(valObj) == -1) {
                                categories.addItem(valObj);
                            }
                        }
                    }
                }


                var xAxis:IAxis;

                if (xAxisDimension.hasType(AnalysisItemTypes.DATE)) {
                    var dateDimension:AnalysisDateDimension = xAxisDimension as AnalysisDateDimension;
                    var dateAxis:DateTimeAxis = new DateTimeAxis();
                    switch (dateDimension.dateLevel) {
                        case AnalysisItemTypes.YEAR_LEVEL:
                            dateAxis.dataUnits = "years";
                            break;
                        case AnalysisItemTypes.MONTH_LEVEL:
                            dateAxis.dataUnits = "months";
                            break;
                        case AnalysisItemTypes.DAY_LEVEL:
                            dateAxis.dataUnits = "days";
                            break;
                        case AnalysisItemTypes.HOUR_LEVEL:
                            dateAxis.dataUnits = "hours";
                            break;
                        case AnalysisItemTypes.MINUTE_LEVEL:
                            dateAxis.dataUnits = "minutes";
                            break;
                    }
                    dateAxis.displayName = dateDimension.display;
                    xAxis = dateAxis;
                } else {
                    var categoryAxis:CategoryAxis = new CategoryAxis();
                    categoryAxis.displayName = xAxisDimension.display;
                    categoryAxis.dataProvider = categories;
                    xAxis = categoryAxis;
                }

                lineChart.horizontalAxis = xAxis;

                var mySeries:Array = new Array();
                for each (var analysisMeasure:AnalysisMeasure in lineChartDef.measures) {
                    var uniqueLineSeries:LineSeries = new LineSeries();
                    uniqueLineSeries.xField = lineChartDef.xaxis.qualifiedName();
                    uniqueLineSeries.yField = analysisMeasure.qualifiedName();
                    uniqueLineSeries.displayName = analysisMeasure.display;
                    uniqueLineSeries.dataProvider = dataSet;
                    measureMap[analysisMeasure.qualifiedName()] = analysisMeasure;
                    mySeries.push(uniqueLineSeries);
                }

                lineChart.series = mySeries;
            }

            legend.dataProvider = lineChart;
            legend.direction = "vertical";
            hbox.addChildAt(lineChart, 0);
        }


        public function createFilterRawData():FilterRawData {
            return null;
        }

        public function updateExportMetadata():void {
        }

        public function preserveValues():Boolean {
            return false;
        }

        public function onCustomChangeEvent(event:CustomChangeEvent):void {
        }]]></mx:Script>
    <mx:HBox width="100%" height="100%" id="hbox"/>
</mx:Module>