<?xml version="1.0" ?>
<mx:Module xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:visualization="com.michaelvandaniker.visualization.*"
           implements="com.easyinsight.analysis.IReportRenderer">
    <mx:Script><![CDATA[
        import com.easyinsight.analysis.AnalysisDefinition;
        import com.easyinsight.analysis.CustomChangeEvent;
        import com.easyinsight.filtering.FilterRawData;

        import com.google.maps.LatLng;
        import com.google.maps.MapEvent;

        import com.sunild.maps.GHeatMapOverlay;

        import mx.collections.ArrayCollection;

        private var heatMapDefinition:HeatMapDefinition;

        private function onMapReady(event:com.google.maps.MapEvent):void {

        }

        public function renderReport(dataSet:ArrayCollection, analysisDefinition:AnalysisDefinition, clientProcessorMap:Object, additionalProperties:Object):void {
            if (dataSet.length > 0) {
                heatMapDefinition = analysisDefinition as HeatMapDefinition;
                heatMap.dataProvider = dataSet;
                map.addOverlay(new GHeatMapOverlay(heatMap));
            }
        }

        public function createFilterRawData():FilterRawData {
            return null;
        }

        public function updateExportMetadata():void {
        }

        private function latLonToPoint(o:Object):Object {
            return map.fromLatLngToViewport(new LatLng(o[heatMapDefinition.latitudeItem.qualifiedName()] as Number, o[heatMapDefinition.longitudeItem.qualifiedName()] as Number));
        }
        private function getCount(o:Object):Number {
            var n = o[heatMapDefinition.measure.qualifiedName()] as Number;
            return n;
        }

        public function onCustomChangeEvent(event:CustomChangeEvent):void {
        }]]></mx:Script>
    <maps:Map xmlns:maps="com.google.maps.*" id="map" mapevent_mapready="onMapReady(event)" 
  width="100%" height="100%" key="ABQIAAAAnyGynqFqd0LwEilMNiY3fRSLyjrNh4Cxk4UOOo9GwtzG_Q7CfBQhU5o9H5gNTuxwV6qhAhJdlzoNpQ" />
    <visualization:HeatMap id="heatMap" transformationFunction="{latLonToPoint}" weightFunction="{getCount}" alpha=".57" backgroundAlpha="0.0" backgroundColor="0"  />
</mx:Module>