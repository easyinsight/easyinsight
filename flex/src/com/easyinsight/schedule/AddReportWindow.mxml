<?xml version="1.0" encoding="utf-8"?>
<util:EISlimWindow xmlns:util="com.easyinsight.util.*" xmlns:mx="http://www.adobe.com/2006/mxml"
                   creationComplete="setup()">
    <mx:Script>
		<![CDATA[
        import com.easyinsight.solutions.InsightDescriptor;

        import mx.collections.Sort;
        import mx.collections.SortField;
        import mx.managers.PopUpManager;
        import mx.collections.ArrayCollection;

        [Bindable]
        private var descriptors:ArrayCollection;

        private var _dataSourceID:int;

        private function setup():void {
            if (_dataSourceID == 0) {
                analysisService.getInsightDescriptorsWithConfigurations.send();
            } else {
                analysisService.getInsightDescriptorsForDataSource.send(_dataSourceID);
            }
        }

        public function set dataSourceID(value:int):void {
            _dataSourceID = value;
        }

        private function gotReportsForDataSource():void {
            var descriptors:ArrayCollection = analysisService.getInsightDescriptorsForDataSource.lastResult as ArrayCollection;
            var sort:Sort = new Sort();
            sort.fields = [ new SortField("name", true) ];
            descriptors.sort = sort;
            descriptors.refresh();
            this.descriptors = descriptors;
        }

        private function gotReports():void {
            var descriptors:ArrayCollection = analysisService.getInsightDescriptorsWithConfigurations.lastResult as ArrayCollection;
            var sort:Sort = new Sort();
            sort.fields = [ new SortField("name", true) ];
            descriptors.sort = sort;
            descriptors.refresh();
            this.descriptors = descriptors;
        }

        private function chose():void {
            var descriptor:InsightDescriptor = feedBox.selectedItem as InsightDescriptor;
            var info:DeliveryInfo = new DeliveryInfo();
            info.type = DeliveryInfo.REPORT;
            info.id = descriptor.id;
            info.dataSourceID = descriptor.dataFeedID;
            info.name = descriptor.name;
            dispatchEvent(new DeliveryInfoEvent(DeliveryInfoEvent.ADD_REPORT, info));
            PopUpManager.removePopUp(this);
        }

        private function cancel():void {
            PopUpManager.removePopUp(this);
        }
        ]]>
	</mx:Script>
    <mx:RemoteObject destination="analysisDefinition" id="analysisService">
        <mx:method name="getInsightDescriptorsWithConfigurations" result="gotReports()"/>
        <mx:method name="getInsightDescriptorsForDataSource" result="gotReportsForDataSource()"/>
    </mx:RemoteObject>


    <mx:ComboBox id="feedBox" dataProvider="{descriptors}" selectedIndex="0" labelField="name"/>

    <mx:HBox>
        <util:SaveButton label="OK" click="chose()"/>
        <util:CancelButton label="Cancel" click="cancel()"/>
    </mx:HBox>


</util:EISlimWindow>
