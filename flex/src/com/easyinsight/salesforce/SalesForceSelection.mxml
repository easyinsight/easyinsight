<?xml version="1.0" encoding="utf-8"?>
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml" width="100%" height="100%" xmlns:local="com.easyinsight.*" 
	creationComplete="initHandlers()" xmlns:salesforce="com.easyinsight.salesforce.*" 
	implements="com.easyinsight.listing.IPerspective" xmlns:listing="com.easyinsight.listing.*" 
	backgroundColor="#FFFFFF" backgroundAlpha=".25">
	<mx:states>
		<mx:State name="notLoggedIn">			
			<mx:AddChild relativeTo="{coreContent}">
				<listing:GottaLoginPage loginEvent2="loggedIn()"/>
			</mx:AddChild>
		</mx:State>
		<mx:State name="NoLicense">
			<mx:AddChild relativeTo="{coreContent}">
				<mx:VBox width="100%" height="100%">			
					<mx:TextArea text="Take advantage of your pipeline to "/>
					<mx:Form backgroundColor="#FFFFFF" backgroundAlpha=".75">
						<mx:FormItem label="User Name: " direction="horizontal">
							<mx:TextInput id="userNameInput"/>
						</mx:FormItem>
						<mx:FormItem label="Password: " direction="horizontal">
							<mx:TextInput id="passwordInput" displayAsPassword="true"/>
						</mx:FormItem>
						<mx:FormItem label="Security Token: " direction="horizontal">
							<mx:TextInput id="securityToken" displayAsPassword="true"/>
						</mx:FormItem>
						<mx:FormItem label="" direction="horizontal" id="failureForm" visible="false">
							<mx:Text id="failureMessage" visible="false"/>
						</mx:FormItem>
						<mx:FormItem label="" direction="vertical" id="progressForm" visible="false">
							<mx:Text text="Creating the feed, this may take a while..."/>
							<mx:ProgressBar id="progressBar" indeterminate="true"/>
						</mx:FormItem>
						<mx:FormItem label="" direction="horizontal">
						</mx:FormItem>
						<mx:Button id="signupButton" label="Sign up" click="signup()"/>
					</mx:Form>
					
				</mx:VBox>
			</mx:AddChild>
		</mx:State>
		<mx:State name="License">
			<mx:AddChild relativeTo="{coreContent}">
				<mx:VBox width="100%" height="100%">
					<mx:Text text="blah"/>
				</mx:VBox>
			</mx:AddChild>
		</mx:State>
	</mx:states>
	<mx:Script>
		<![CDATA[
			import com.easyinsight.listing.AnalyzeSource;
			import com.easyinsight.listing.DataFeedDescriptor;
			import com.easyinsight.framework.User;
			
			private function initHandlers():void {
				
			}
			
			private function checkLicense():void {
				salesforceService.getLicenseEstablished.send();				
			}
			
			private function loggedIn():void {
				checkLicense();
			}
			
			public function search(keyword:String):void {

            }
            
            private function signup():void {
				salesforceService.createFeed.send(userNameInput.text, passwordInput.text, securityToken.text);
				progressForm.visible = true;
				progressBar.visible = true;
				signupButton.enabled = false;
			}

            public function analyze():AnalyzeSource {
                return null;
            }

            public function gotFocus():void {
            	var user:User = User.getInstance();
                if (user == null) {
                    currentState="notLoggedIn";
                } else {
                	checkLicense();
                }				
            }

            public function getDefaultAnalyzeState():Boolean {
                return false;
            }

            public function isKeywordSearchInstant():Boolean {
                return false;
            }
		
			public function gotLicenseEstablished():void {
				var feedDescriptor:DataFeedDescriptor = salesforceService.getLicenseEstablished.lastResult as 
					DataFeedDescriptor;
				if (feedDescriptor == null) {
					currentState = "NoLicense";
				} else {
					currentState = "License";
				} 
			}		
		
			public function createdFeed():void {
				progressForm.visible = false;
				progressBar.visible = false;
				var salesforceCreationResponse:SalesforceCreationResponse = salesforceService.createFeed.lastResult as 
					SalesforceCreationResponse;
				if (salesforceCreationResponse.successful) {
					currentState = "License";
				} else {
					failureMessage.text = salesforceCreationResponse.failureMessage;
					failureForm.visible = true;
					failureMessage.visible = true;
				}
			}
        ]]>
	</mx:Script>
	<mx:RemoteObject id="salesforceService" destination="salesforce">
		<mx:method name="createFeed" result="createdFeed()"/>
		<mx:method name="getLicenseEstablished" result="gotLicenseEstablished()"/>
	</mx:RemoteObject>				
	<mx:VBox id="coreContent" width="100%" height="100%"/>
</mx:VBox>
