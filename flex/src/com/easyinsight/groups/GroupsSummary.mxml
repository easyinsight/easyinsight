<?xml version="1.0" encoding="utf-8"?>
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:util="com.easyinsight.util.*"
           implements="com.easyinsight.listing.IPerspective"
           creationComplete="initListeners()" width="100%" height="100%" styleName="basePageVBox">
    <mx:Script>
		<![CDATA[
        import com.easyinsight.account.Account;
        import com.easyinsight.account.AccountInfo;
        import com.easyinsight.util.PopUpUtil;

        import com.easyinsight.framework.User;

        import com.easyinsight.util.ProgressAlert;

        import mx.managers.PopUpManager;
        import mx.collections.ArrayCollection;

        [Bindable]
        private var myGroups:ArrayCollection;

        [Bindable]
        private var showMyGroups:Boolean = false;

        private function initListeners():void {
            addEventListener(GroupSelectedEvent.GROUP_SELECTED, groupSelected);
            addEventListener(GroupSelectedEvent.GROUP_DELETE, groupDelete);
            gotFocus();
        }

        private function groupDelete(event:GroupSelectedEvent):void {
            ProgressAlert.alert(this, "Deleting group...", null, groupService.deleteGroup);
            groupService.deleteGroup.send(event.groupID);
        }

        private function deletedGroup():void {
            groupService.getAccountGroups.send();
        }

        private function gotCreate():void {
            var canCreateGroup:Boolean = groupService.canCreateGroup.lastResult as Boolean;

            if (canCreateGroup) {
                groupAddIndex = 3;
            } else {
                groupAddIndex = 2;
            }
        }

        public function gotFocus():void {
            if (User.getInstance().getAccountType() == Account.PERSONAL) {
                groupAddIndex = 1;
            } else {
                groupService.canCreateGroup.send();
            }
            stackIndex = 0;
            groupService.getAccountGroups.send();
            //groupService.getPublicGroups.send();
        }

        private function groupSelected(event:GroupSelectedEvent):void {
            var window:GroupDetail = new GroupDetail();
            window.groupID = event.groupID;
            PopUpManager.addPopUp(window, this, true);
            PopUpUtil.centerPopUp(window);
        }

        private function gotAccountGroups():void {
            stackIndex = 1;
            this.myGroups = groupService.getAccountGroups.lastResult as ArrayCollection;
            showMyGroups = (myGroups.length > 0);
        }

        private function createNewGroup():void {
            var groupWindow:NewGroupWindow = NewGroupWindow(PopUpManager.createPopUp(this, NewGroupWindow, true));
            groupWindow.addEventListener(GroupSelectedEvent.GROUP_SELECTED, onNewGroup, false, 0, true);
            PopUpUtil.centerPopUp(groupWindow);
        }

        private function onNewGroup(event:GroupSelectedEvent):void {
            groupService.getAccountGroups.send();
            groupSelected(event);
        }

        [Bindable]
        public var accountInfo:AccountInfo;

        public function cleanup():void {
        }

        [Bindable]
        private var stackIndex:int;

        [Bindable]
        private var groupAddIndex:int = 0;
        ]]>
    </mx:Script>
    <mx:RemoteObject destination="groupService" id="groupService">
        <mx:method name="getAccountGroups" result="gotAccountGroups()"/>
        <mx:method name="canCreateGroup" result="gotCreate()"/>
        <mx:method name="deleteGroup" result="deletedGroup()"/>
    </mx:RemoteObject>
    <mx:Box width="100%" styleName="bannerBackground">
        <mx:Label text="Group Configuration" styleName="bannerText"/>
    </mx:Box>
    <mx:ViewStack resizeToContent="true" selectedIndex="{groupAddIndex}">
        <mx:Box/>
        <mx:Box width="100%" horizontalAlign="center" verticalAlign="middle" height="100%">
            <mx:Label text="You are only able to create groups with a Basic or higher account." fontSize="16"
                      color="#000000"/>
        </mx:Box>
        <mx:Box width="100%" horizontalAlign="center" verticalAlign="middle" height="100%">
            <mx:Label text="You are only allowed to have one group with a Basic account." fontSize="16"
                      color="#000000"/>
        </mx:Box>
        <mx:Box width="100%" horizontalAlign="center" verticalAlign="middle" height="100%">
            <mx:Button label="Create a New Group..."
                       click="createNewGroup()" labelPlacement="bottom" styleName="grayButton" fontSize="14"/>
        </mx:Box>
    </mx:ViewStack>
    <mx:DataGrid dataProvider="{myGroups}" rowHeight="28">
        <mx:columns>
            <util:EIDataGridColumn dataField="name" headerText="Group Name" width="400"/>
            <util:EIDataGridColumn dataField="name" itemRenderer="com.easyinsight.groups.GroupSummaryActions"
                    headerText="" sortable="false" width="100"/>
        </mx:columns>
    </mx:DataGrid>
</mx:VBox>
