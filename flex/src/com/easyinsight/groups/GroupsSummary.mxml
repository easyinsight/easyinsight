<?xml version="1.0" encoding="utf-8"?>
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:util="com.easyinsight.util.*"
         xmlns:discussion="com.easyinsight.discussion.*" width="100%" height="100%"
         implements="com.easyinsight.listing.IPerspective"
         xmlns:groups="com.easyinsight.groups.*"
         creationComplete="initListeners()" xmlns:listing="com.easyinsight.listing.*"
         paddingTop="0" paddingLeft="0" paddingRight="0" paddingBottom="0" verticalGap="0"
         backgroundColor="#818285" horizontalAlign="center">
    <mx:Script>
		<![CDATA[

        import com.easyinsight.account.Account;
        import com.easyinsight.util.PopUpUtil;

        import mx.utils.URLUtil;
        import mx.managers.BrowserManager;

        import com.easyinsight.framework.LoginEvent;
        import com.easyinsight.framework.NavigationEvent;
        import com.easyinsight.framework.User;

        import mx.managers.PopUpManager;
        import mx.collections.ArrayCollection;

        [Bindable]
        private var myGroups:ArrayCollection;

        [Bindable]
        private var showMyGroups:Boolean = false;

        private function initListeners():void {
        }

        private function gotCreate():void {
            var canCreateGroup:Boolean = groupService.canCreateGroup.lastResult as Boolean;

            if (canCreateGroup) {
                groupAddIndex = 3;
            } else {
                groupAddIndex = 2;
            }
        }

        public function gotFocus():void {
            var fragmentObject:Object = new Object();
            fragmentObject.page = "groups";
            BrowserManager.getInstance().setTitle("Easy Insight - Groups");
            var fragmentString:String = URLUtil.objectToString(fragmentObject);
            BrowserManager.getInstance().setFragment(fragmentString);
            if (User.getInstance().getAccountType() == Account.PERSONAL) {
                groupAddIndex = 1;
            } else {
                groupService.canCreateGroup.send();
            }
            stackIndex = 0;
            groupService.getMemberGroups.send();
            //groupService.getPublicGroups.send();
        }

        public function lostFocus():void {
        }

        private function groupSelected(event:GroupSelectedEvent):void {
            var groupDetail:GroupDetail = new GroupDetail();
            groupDetail.groupID = event.groupID;
            User.getEventNotifier().dispatchEvent(new NavigationEvent(null, groupDetail));
        }

        private function onNewGroup(event:GroupSelectedEvent):void {
            if (User.getInstance().getAccountType() == Account.BASIC) {
                groupAddIndex = 2;
            }
            var groupDetail:GroupDetail = new GroupDetail();
            groupDetail.groupID = event.groupID;
            User.getEventNotifier().dispatchEvent(new NavigationEvent(null, groupDetail));
        }

        private function gotMemberGroups():void {
            stackIndex = 1;
            this.myGroups = groupService.getMemberGroups.lastResult as ArrayCollection;
            showMyGroups = (myGroups.length > 0);
        }

        /*private function gotPublicGroups():void {
         this.publicGroups = groupService.getPublicGroups.lastResult as ArrayCollection;
         publicGroupRowCount = this.publicGroups.length;
         }*/

        private function createNewGroup():void {
            var groupWindow:NewGroupWindow = NewGroupWindow(PopUpManager.createPopUp(this, NewGroupWindow, true));
            groupWindow.addEventListener(GroupSelectedEvent.GROUP_SELECTED, groupSelected);
            PopUpUtil.centerPopUp(groupWindow);
        }

        /*private function joinPublicGroup():void {
         var groupJoinWindow:GroupJoinWindow = new GroupJoinWindow();
         groupJoinWindow.addEventListener(GroupSelectedEvent.GROUP_SELECTED, groupSelected);
         PopUpManager.addPopUp(groupJoinWindow, this, true);
         PopUpUtil.centerPopUp(groupJoinWindow);
         }*/
        public function cleanup():void {
        }

        [Bindable]
        [Embed(source="../../../../assets/background2.JPG")]
        private var background2:Class;

        [Bindable]
        private var stackIndex:int;

        [Bindable]
        private var groupAddIndex:int = 0;
        ]]>
    </mx:Script>
    <mx:RemoteObject destination="groupService" id="groupService">
        <mx:method name="getMemberGroups" result="gotMemberGroups()"/>
        <mx:method name="canCreateGroup" result="gotCreate()"/>
        <!--<mx:method name="getPublicGroups" result="gotPublicGroups()"/>-->
    </mx:RemoteObject>    
    
    <mx:VBox width="1000" height="100%" id="coreContent" backgroundColor="#FFFFFF" paddingTop="10" paddingLeft="10"
             paddingRight="10" paddingBottom="10">
        <mx:HBox width="100%" horizontalAlign="center" id="topBox" height="80">
            <mx:ViewStack resizeToContent="true" selectedIndex="{groupAddIndex}" width="100%" height="100%">
                <mx:Box/>
                <mx:Box width="100%" horizontalAlign="center" verticalAlign="middle" height="100%">
                    <mx:Label text="You are only able to create groups with a Basic or higher account." fontSize="16" color="#000000"/>
                </mx:Box>
                <mx:Box width="100%" horizontalAlign="center" verticalAlign="middle" height="100%">
                    <mx:Label text="You are only allowed to have one group with a Basic account." fontSize="16" color="#000000"/>
                </mx:Box>
                <mx:Box width="100%" horizontalAlign="center" verticalAlign="middle" height="100%">
                    <mx:Button icon="@Embed('../../../../assets/users3_add.png')" label="Create a New Group..."
                       click="createNewGroup()" labelPlacement="bottom"/>
                </mx:Box>
            </mx:ViewStack>
        </mx:HBox>
        <mx:ViewStack width="100%" height="100%" selectedIndex="{stackIndex}" id="groupStack">
            <mx:Box width="100%" height="100%" horizontalAlign="center" verticalAlign="middle">
                <mx:ProgressBar indeterminate="true" label="Loading available groups..."/>
            </mx:Box>
            <mx:Canvas width="100%" height="100%">
                <mx:TileList width="100%" height="100%" itemRenderer="com.easyinsight.groups.GroupView" dataProvider="{myGroups}" id="solutionGrid"
                    columnWidth="240" rowHeight="160"  backgroundImage="{background2}" backgroundSize="100%"/>
            </mx:Canvas>
        </mx:ViewStack>
    </mx:VBox>
</mx:VBox>
