<?xml version="1.0" encoding="utf-8"?>
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:util="com.easyinsight.util.*"
         xmlns:discussion="com.easyinsight.discussion.*" width="100%" height="100%"
         implements="com.easyinsight.listing.IPerspective"
         xmlns:groups="com.easyinsight.groups.*" backgroundColor="#DCE2F8"
         creationComplete="initListeners()" xmlns:listing="com.easyinsight.listing.*"
         paddingTop="0" paddingLeft="0" paddingRight="0" paddingBottom="0" verticalGap="0">
    <mx:states>
        <mx:State name="notLoggedIn">
            <mx:RemoveChild target="{topBox}"/>
            <mx:RemoveChild target="{bodyBox}"/>
            <mx:AddChild relativeTo="{coreContent}">
                <listing:GottaLoginPage/>
            </mx:AddChild>
        </mx:State>
    </mx:states>
    <mx:Script>
		<![CDATA[
        import com.easyinsight.account.Account;

        import com.easyinsight.util.PopUpUtil;

        import mx.utils.URLUtil;
        import mx.managers.BrowserManager;

        import com.easyinsight.framework.LoginEvent;
        import com.easyinsight.framework.NavigationEvent;
        import com.easyinsight.framework.User;

        import mx.managers.PopUpManager;
        import mx.collections.ArrayCollection;

        [Bindable]
        private var myGroups:ArrayCollection;

        [Bindable]
        private var showMyGroups:Boolean = false;

        [Bindable]
        private var individualOrHigherAccount:Boolean = false;

        private function initListeners():void {
            User.getEventNotifier().addEventListener(LoginEvent.LOGIN, onLogin);
        }

        private function onLogin(event:LoginEvent):void {
            gotFocus();
        }

        public function gotFocus():void {
            var fragmentObject:Object = new Object();
            fragmentObject.page = "groups";
            BrowserManager.getInstance().setTitle("Easy Insight - Groups");
            var fragmentString:String = URLUtil.objectToString(fragmentObject);
            BrowserManager.getInstance().setFragment(fragmentString);
            var user:User = User.getInstance();
            if (user == null) {
                currentState = "notLoggedIn";
            } else {
                if (currentState != "") {
                    currentState = "";
                }
                individualOrHigherAccount = User.getInstance().getAccountType() >= Account.GROUP;
                groupService.getMemberGroups.send();
                //groupService.getPublicGroups.send();
                groupComments.retrieveMessages();
            }
        }

        public function lostFocus():void {
        }

        private function groupSelected(event:GroupSelectedEvent):void {
            var groupDetail:GroupDetail = new GroupDetail();
            groupDetail.groupID = event.groupID;
            User.getEventNotifier().dispatchEvent(new NavigationEvent(null, groupDetail));
        }

        private function gotMemberGroups():void {
            this.myGroups = groupService.getMemberGroups.lastResult as ArrayCollection;
            showMyGroups = (myGroups.length > 0);
        }

        /*private function gotPublicGroups():void {
         this.publicGroups = groupService.getPublicGroups.lastResult as ArrayCollection;
         publicGroupRowCount = this.publicGroups.length;
         }*/

        private function createNewGroup():void {
            var groupWindow:NewGroupWindow = NewGroupWindow(PopUpManager.createPopUp(this, NewGroupWindow, true));
            groupWindow.addEventListener(GroupSelectedEvent.GROUP_SELECTED, groupSelected);
            PopUpUtil.centerPopUp(groupWindow);
        }

        /*private function joinPublicGroup():void {
         var groupJoinWindow:GroupJoinWindow = new GroupJoinWindow();
         groupJoinWindow.addEventListener(GroupSelectedEvent.GROUP_SELECTED, groupSelected);
         PopUpManager.addPopUp(groupJoinWindow, this, true);
         PopUpUtil.centerPopUp(groupJoinWindow);
         }*/
        public function cleanup():void {
        }
        ]]>
    </mx:Script>
    <mx:RemoteObject destination="groupService" id="groupService">
        <mx:method name="getMemberGroups" result="gotMemberGroups()"/>
        <!--<mx:method name="getPublicGroups" result="gotPublicGroups()"/>-->
    </mx:RemoteObject>
    <mx:Box width="100%" height="100%" backgroundColor="#818285" horizontalAlign="center">
        <mx:VBox width="1000" height="100%" id="coreContent" paddingTop="10" paddingLeft="10" paddingRight="10"
                 paddingBottom="10" backgroundColor="#FFFFFF" verticalGap="15">
            <mx:HBox width="100%" id="topBox">
                <mx:Button icon="@Embed('../../../../assets/users3_add.png')" label="Create a New Group..."
                           click="createNewGroup()" labelPlacement="bottom" visible="{individualOrHigherAccount}"/>
                <!--<mx:Button icon="@Embed('../../../../assets/earth_new.png')" label="Join a Public Group..."
                           click="joinPublicGroup()" labelPlacement="bottom"/>-->
                <!--<mx:Button icon="@Embed('../../../../assets/helpx48.png')" label="Help..." labelPlacement="bottom"/>-->
            </mx:HBox>
            <mx:VBox width="100%" id="bodyBox">
                <mx:HBox width="100%">
                    <mx:VBox width="300" verticalGap="0">
                        <mx:Box width="100%" height="5" backgroundColor="#D42525" left="0" right="0"/>
                        <mx:Box width="100%" backgroundColor="#F6A76B" horizontalAlign="center">
                            <mx:Label fontSize="14" text="My Groups"/>
                        </mx:Box>
                        <mx:DataGrid id="myGroupsGrid" dataProvider="{myGroups}" headerStyleName="BlueHeader" width="100%">
                            <mx:columns>
                                <util:EIDataGridColumn dataField="name" headerText="Name"/>
                                <util:EIDataGridColumn dataField="name" width="50" headerText="" sortable="false"
                                                       itemRenderer="com.easyinsight.groups.MyGroupsControls"/>
                            </mx:columns>
                        </mx:DataGrid>
                    </mx:VBox>
                    <mx:Spacer width="50"/>
                    <mx:TextArea width="100%" fontSize="14" borderStyle="none" editable="false" text="Groups provide you with the functionality to collaborate on data problems. You can add data sources, reports, and KPIs to groups. Groups are limited to accounts of the Group level and higher." height="120"/>
                </mx:HBox>
                <mx:Spacer height="10"/>
                <discussion:GroupWideDiscussionPanel width="100%" id="groupComments"/>
            </mx:VBox>
        </mx:VBox>
    </mx:Box>
</mx:VBox>
