<?xml version="1.0"?>
<util:EISlimWindow xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:util="com.easyinsight.util.*"
        creationComplete="onCreation()">
    <mx:Script><![CDATA[

        import mx.collections.ArrayCollection;
        import mx.controls.Alert;
        import mx.managers.PopUpManager;

        [Bindable]
        private var _dataSources:ArrayCollection;

        private var _existingConnection:CompositeFeedConnection;

        public function set existingConnection(value:CompositeFeedConnection):void {
            _existingConnection = value;
            connectionLabel = value.display;
            leftJoin = _existingConnection.sourceOuterJoin;
            rightJoin = _existingConnection.targetOuterJoin;
            leftOriginal = _existingConnection.sourceJoinOnOriginal;
            rightOriginal = _existingConnection.targetJoinOnOriginal;
            marmotScript = _existingConnection.marmotScript;

            sourceCardinalityOption = (_existingConnection.sourceCardinality == CompositeFeedConnection.ONE) ? "One" : "Many";
            targetCardinalityOption = (_existingConnection.targetCardinality == CompositeFeedConnection.ONE) ? "One" : "Many";
            forceOuterJoin = _existingConnection.forceOuterJoin == 1;
            joinType = _existingConnection is CompositeFeedCompositeConnection ? "Composite" : "Direct";
        }

        [Bindable]
        private var forceOuterJoin:Boolean;
        
        [Bindable]
        private var marmotScript:String;

        [Bindable]
        private var index:int;

        [Bindable]
        private var sourceFeedName:String;

        [Bindable]
        private var targetFeedName:String;

        [Bindable]
        private var sourceFields:ArrayCollection;

        [Bindable]
        private var targetFields:ArrayCollection;

        private var sourceID:int;

        private var targetID:int;

        public var metadataFields:ArrayCollection;

        private function onCreation():void {
        }

        [Bindable]
        private var leftJoin:Boolean = false;

        [Bindable]
        private var rightJoin:Boolean = false;

        [Bindable]
        private var leftOriginal:Boolean = false;

        [Bindable]
        private var rightOriginal:Boolean = false;

        [Bindable]
        private var sourceFieldName:String;

        [Bindable]
        private var targetFieldName:String;

        private function join():void {
            _existingConnection.sourceOuterJoin = leftJoinCheckbox.selected;
            _existingConnection.targetOuterJoin = rightJoinCheckbox.selected;
            _existingConnection.sourceJoinOnOriginal = leftMatchCheckbox.selected;
            _existingConnection.targetJoinOnOriginal = rightMatchCheckbox.selected;
            _existingConnection.marmotScript = marmotScriptArea.text;
            _existingConnection.sourceCardinality = sourceCardinality.selectedItem == "One" ? CompositeFeedConnection.ONE : CompositeFeedConnection.MANY;
            _existingConnection.targetCardinality = targetCardinality.selectedItem == "One" ? CompositeFeedConnection.ONE : CompositeFeedConnection.MANY;
            _existingConnection.forceOuterJoin = ensureOuterJoinCheckbox.selected ? 1 : 0;
            dispatchEvent(new JoinEditEvent(_existingConnection));
            PopUpManager.removePopUp(this);
        }

        [Bindable]
        private var advancedIndex:int = 0;

        private function toggleAdvanced():void {
            if (advancedIndex == 1) {
                advancedIndex = 0;
            } else {
                advancedIndex = 1;
            }
        }

        [Bindable]
        private var joinType:String;

        [Bindable]
        private var connectionLabel:String;

        [Bindable]
        private var sourceCardinalityOption:String = "One";

        [Bindable]
        private var targetCardinalityOption:String = "One";
        ]]></mx:Script>
    <mx:Text text="{joinType}"/>
    <mx:Text text="{connectionLabel}" maxWidth="400"/>
    <mx:HBox width="100%" verticalAlign="middle">
        <mx:CheckBox label="Ensure Outer Join" id="ensureOuterJoinCheckbox" selected="{forceOuterJoin}"/>
        <mx:Spacer width="100%"/>
        <mx:ComboBox id="sourceCardinality" selectedItem="{sourceCardinalityOption}">
            <mx:dataProvider>
                <mx:ArrayCollection>
                    <mx:String>One</mx:String>
                    <mx:String>Many</mx:String>
                </mx:ArrayCollection>
            </mx:dataProvider>
        </mx:ComboBox>
        <mx:Label text="to"/>
        <mx:ComboBox id="targetCardinality" selectedItem="{targetCardinalityOption}">
            <mx:dataProvider>
                <mx:ArrayCollection>
                    <mx:String>One</mx:String>
                    <mx:String>Many</mx:String>
                </mx:ArrayCollection>
            </mx:dataProvider>
        </mx:ComboBox>
    </mx:HBox>
    <mx:LinkButton label="Advanced Options" textDecoration="underline" click="toggleAdvanced()"/>
    <mx:ViewStack selectedIndex="{advancedIndex}" resizeToContent="true" creationPolicy="all">
        <mx:Box/>
        <mx:VBox>
            <mx:Text text="{connectionLabel}" width="400"/>
            <mx:HBox>
                <mx:VBox>

                    <mx:CheckBox label="Only Keep Matching Rows From Source (Inner Join)" id="leftJoinCheckbox"/>
                    <!-- hide -->
                    <mx:CheckBox label="Match Source Against Original Data" id="leftMatchCheckbox"/>
                </mx:VBox>
                <mx:VBox>

                    <mx:CheckBox label="Only Keep Matching Rows From Target (Inner Join)" id="rightJoinCheckbox"/>
                    <!-- hide -->
                    <mx:CheckBox label="Match Target Against Original Data" id="rightMatchCheckbox"/>
                </mx:VBox>
            </mx:HBox>
            <mx:Form>
                <mx:FormItem label="Code">
                    <mx:TextArea width="300" height="50" text="{marmotScript}" editable="true" id="marmotScriptArea" borderStyle="inset" borderThickness="1"/>
                </mx:FormItem>
            </mx:Form>
        </mx:VBox>
    </mx:ViewStack>
    <mx:HBox width="100%" horizontalAlign="center">
        <util:SaveButton label="Use These Fields" click="join()"/>
        <util:CancelButton label="Cancel" click="PopUpManager.removePopUp(this)"/>
    </mx:HBox>
</util:EISlimWindow>
