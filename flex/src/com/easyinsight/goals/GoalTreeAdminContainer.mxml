<?xml version="1.0" encoding="utf-8"?>
<FullScreenPage xmlns="com.easyinsight.*" xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:goals="com.easyinsight.goals.*"
	width="100%" height="100%" backgroundColor="#DCE2F8" creationComplete="onCreation()">
	<mx:Script>
		<![CDATA[
        import com.easyinsight.administration.sharing.UserStub;
        import com.easyinsight.framework.User;
        import com.easyinsight.util.ProgressAlert;

        import mx.collections.ArrayCollection;

        import com.easyinsight.analysis.AnalysisCloseEvent;

        [Bindable]
        private var _goalTree:GoalTree;
        [Bindable]
        private var goalTreeName:String;
        [Bindable]
        private var _goalTreeID:int;
        [Bindable]
        private var goalTreeDescription:String;
        [Bindable]
        private var rootNode:GoalTreeNode;
        [Bindable]
        private var newSolutions:ArrayCollection = new ArrayCollection();

        public function set goalTreeID(val:int):void {
            _goalTreeID = val;
        }

        private function onCreation():void {
            addEventListener(SolutionInstallRequiredEvent.SOLUTION_INSTALL, onNewSolution);
        }

        override protected function createChildren():void {
            super.createChildren();
            if (_goalTreeID == 0) {
                _goalTree = new GoalTree();
                _goalTree.rootNode = new GoalTreeNode();
                var userStub:UserStub = new UserStub();
                userStub.userID = User.getInstance().userID;
                _goalTree.administrators.addItem(userStub);
                rootNode = _goalTree.rootNode;
            } else {
                ProgressAlert.alert(this, "Retrieving goal tree...", null, goalService.getGoalTree);
                goalService.getGoalTree.send(_goalTreeID);
            }
        }

        private function gotGoalTree():void {
            _goalTree = goalService.getGoalTree.lastResult as GoalTree;
            rootNode = _goalTree.rootNode;
            goalTreeName = _goalTree.name;
            goalTreeDescription = _goalTree.description;
        }

        private function onNewSolution(event:SolutionInstallRequiredEvent):void {
            newSolutions.addItem(event.solutionDescriptor.solutionID);
        }

        private function process(rootNode:GoalTreeNode):void {
            rootNode.updateName();
            if (rootNode.children != null) {
                for each (var node:GoalTreeNode in rootNode.children) {
                    process(node);
                }
            }
        }

        private function save():void {
            _goalTree.name = nameInput.text;
            _goalTree.description = descriptionTextArea.text;
            _goalTree.newSolutions = newSolutions;
            goalsPolicy.updateContents();
            process(_goalTree.rootNode);
            if (_goalTree.goalTreeID == 0) {
                ProgressAlert.alert(this, "Saving goal tree...", "Saved successfully!", goalService.createGoalTree);
                goalService.createGoalTree.send(_goalTree);
            } else {
                ProgressAlert.alert(this, "Updating goal tree...", "Updated successfully!", goalService.updateGoalTree);
                goalService.updateGoalTree.send(_goalTree);
            }
        }

        private function close():void {
            dispatchEvent(new AnalysisCloseEvent(this));
        }

        private function savedGoalTree():void {
            _goalTree = goalService.createGoalTree.lastResult as GoalTree;
            newSolutions = new ArrayCollection();
            rootNode = _goalTree.rootNode;
            goalTreeID = _goalTree.goalTreeID;
        }

        private function updatedGoalTree():void {
            _goalTree = goalService.updateGoalTree.lastResult as GoalTree;
            newSolutions = new ArrayCollection();
            rootNode = _goalTree.rootNode;
        }
    ]]>
	</mx:Script>
	<mx:RemoteObject destination="goalService" id="goalService">
		<mx:method name="createGoalTree" result="savedGoalTree()"/>
		<mx:method name="updateGoalTree" result="updatedGoalTree()"/>
		<mx:method name="getGoalTree" result="gotGoalTree()"/>
	</mx:RemoteObject>
	<mx:VBox  width="100%" height="100%" paddingLeft="10" paddingTop="10" paddingRight="10" paddingBottom="10">
		<mx:HBox id="buttonBox" paddingLeft="5" paddingTop="5" paddingBottom="5">
            <mx:Button id="wrapButton" icon="@Embed(source='../../../../assets/document_out.png')" click="close()" toolTip="Close"/>
			<mx:Button id="saveButton" icon="@Embed(source='../../../../assets/floppy_disk.png')" click="save()" toolTip="Save"/>
		</mx:HBox>
        <mx:TabNavigator width="100%" height="100%" paddingTop="0" paddingBottom="0"
			paddingLeft="0" paddingRight="0" resizeToContent="true">
            <mx:HBox width="100%" height="100%" label="General">
                <mx:VBox>
					<mx:HBox width="100%" horizontalAlign="center">
						<mx:Box backgroundColor="#FFFFFF" backgroundAlpha=".8" color="#000000" width="50%" horizontalAlign="center">
							<mx:Label text="Fields" fontSize="14"/>
						</mx:Box>
					</mx:HBox>
                    <mx:VBox verticalGap="0">
                        <mx:Box width="100%" height="5" backgroundColor="#10319A" left="0" right="0"/>
                        <mx:Box width="100%" backgroundColor="#3B56AF" horizontalAlign="center">
                            <mx:Label text="Goal Tree Attributes" color="0xFFFFFF"/>
                        </mx:Box>
                        <mx:Form paddingTop="0" paddingLeft="0" paddingBottom="0" paddingRight="0">
                            <mx:FormItem label="Name:" paddingTop="20" fontFamily="Tahoma" fontWeight="bold">
                                <mx:TextInput id="nameInput" text="{goalTreeName}" fontFamily="Lucida Grande" fontWeight="normal"/>
                            </mx:FormItem>
                            <mx:FormItem label="Description:" fontFamily="Tahoma" fontWeight="bold">
                                <mx:TextArea id="descriptionTextArea" width="300" height="60" text="{goalTreeDescription}" fontFamily="Lucida Grande" fontWeight="normal"/>
                            </mx:FormItem>
                        </mx:Form>
                    </mx:VBox>
                </mx:VBox>
                <mx:VBox>
					<mx:HBox width="100%" horizontalAlign="center">
						<mx:Box backgroundColor="#FFFFFF" backgroundAlpha=".8" width="50%" horizontalAlign="center">
							<mx:Label text="Sharing" fontSize="14"/>
						</mx:Box>
					</mx:HBox>
					<goals:GoalSharing id="goalsPolicy" paddingTop="15" paddingLeft="45" goalTree="{_goalTree}"/>
				</mx:VBox>
            </mx:HBox>
            <mx:Canvas width="100%" height="100%" label="Tree">
                <goals:GoalTreeAdminWindow goalTreeNode="{rootNode}" goalTreeID="{_goalTreeID}"/>
            </mx:Canvas>
        </mx:TabNavigator>
	</mx:VBox>
</FullScreenPage>
