<?xml version="1.0" encoding="utf-8"?>
<util:EITitleWindow xmlns:util="com.easyinsight.util.*" xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:solutions="com.easyinsight.solutions.*"
	creationComplete="setup()">
	<mx:states>
		<mx:State name="installComplete">
			<mx:RemoveChild target="{buttonBox}"/>
			<mx:RemoveChild target="{coreForm}"/>
			<mx:RemoveChild target="{objectGrids}"/>
			<mx:AddChild relativeTo="{coreBox}">
				<mx:VBox width="100%" height="100%">
                    <mx:Label text="The objects you've installed will now be available under My Data and Goals." fontSize="14"/>
					<mx:HBox width="100%" horizontalAlign="center">
						<mx:Button label="Close" click="cancel()"/>
					</mx:HBox>					
				</mx:VBox>							
			</mx:AddChild>
		</mx:State>
	</mx:states>
	<mx:Script>
		<![CDATA[
			import com.easyinsight.customupload.ConfigureDataSource;

            import com.easyinsight.genredata.ModuleAnalyzeEvent;

            import com.easyinsight.util.PopUpUtil;
            import com.easyinsight.util.ProgressAlert;

            import mx.collections.ArrayCollection;
			import mx.managers.PopUpManager;

            [Bindable]
            [Embed(source="../../../../assets/data_blue_x16.png")]
            public var dataSourceIcon:Class;

            [Bindable]
            [Embed(source="../../../../assets/chart_column.png")]
            public var insightIcon:Class;

            [Bindable]
            [Embed(source="../../../../assets/branchx16.png")]
            public var goalTreeIcon:Class;
			
			[Bindable]
			private var _solution:Solution;
			
			[Bindable]
			private var solutionName:String;

            [Bindable]
            private var dataSources:ArrayCollection;

            [Bindable]
            private var goalTrees:ArrayCollection;

            [Bindable]
            private var insights:ArrayCollection;
			
			[Bindable]
			private var installResult:ArrayCollection;

            [Bindable]
            private var showDataSources:Boolean;

            [Bindable]
            private var showInsights:Boolean;

            [Bindable]
            private var showGoalTrees:Boolean;

            [Bindable]
            private var dataSourceCount:int;
            [Bindable]
            private var goalCount:int;
            [Bindable]
            private var reportCount:int;

            private function setup():void {
                solutionService.getSolutionContents.send(_solution.solutionID);
            }
			
			public function set solution(solution:Solution):void {
				this._solution = solution;
				solutionName = solution.name;
			}
			
			private function install():void {
                var insightDescriptor:InsightDescriptor;
                ProgressAlert.alert(this, "Installing solution...", null, solutionService.installSolution);
				solutionService.installSolution.send(_solution.solutionID);
			}
			
			private function cancel():void {
				PopUpManager.removePopUp(this);
			}

            private function gotContents():void {
                var solutionContents:SolutionContents = solutionService.getSolutionContents.lastResult as SolutionContents;
                dataSources = solutionContents.feedDescriptors;
                dataSourceCount = dataSources.length;
                showDataSources = dataSources.length > 0;
                insights = solutionContents.insightDescriptors;
                showInsights = insights.length > 0;
                reportCount = insights.length;
                goalTrees = solutionContents.goalTreeDescriptors;
                showGoalTrees = goalTrees.length > 0;
                goalCount = goalTrees.length;
            }

            private function onModuleAnalyze(event:ModuleAnalyzeEvent):void {
                dispatchEvent(event);
            }

            private function installedSolution():void {
				installResult = solutionService.installSolution.lastResult as ArrayCollection;
                var configuredSources:int = 0;
                for each (var solInstall:SolutionInstallInfo in installResult) {
                    if (solInstall.type == SolutionInstallInfo.DATA_SOURCE && solInstall.requiresConfiguration) {
                        configuredSources++;
                    }
                }
                for each (var solutionInstallInfo:SolutionInstallInfo in installResult) {
                    if (solutionInstallInfo.type == SolutionInstallInfo.DATA_SOURCE && solutionInstallInfo.requiresConfiguration) {
                        var configWindow:ConfigureDataSource = new ConfigureDataSource();
                        configWindow.dataSourceID = solutionInstallInfo.newID;
                        configWindow.onlyDataSource = configuredSources == 1;
                        configWindow.addEventListener(ModuleAnalyzeEvent.MODULE_ANALYZE, onModuleAnalyze);
                        PopUpManager.addPopUp(configWindow, this, true);
                        PopUpUtil.centerPopUp(configWindow);
                    }
                }
				PopUpManager.removePopUp(this);			
				dispatchEvent(new SolutionEvent(SolutionEvent.SOLUTION_INSTALLED, _solution.solutionID));
			}
		]]>
	</mx:Script>
	<mx:RemoteObject destination="solutionService" id="solutionService">
		<mx:method name="installSolution" result="installedSolution()"/>
		<mx:method name="getSolutionContents" result="gotContents()"/>
	</mx:RemoteObject>
	<mx:VBox id="coreBox" styleName="TitleWindowContents" paddingLeft="10" paddingTop="10" paddingRight="10" paddingBottom="10"
		width="100%" height="100%">
		<mx:HBox width="100%" horizontalAlign="center">
			<mx:Label fontSize="14" text="Solution Summary"/>
		</mx:HBox>
        <mx:VBox width="100%" horizontalAlign="center" id="coreForm">
            <mx:Form paddingTop="0" paddingBottom="0" paddingLeft="0" paddingRight="0">
                <mx:FormItem label="Solution Name:">
                    <mx:Label text="{solutionName}"/>
                </mx:FormItem>
            </mx:Form>
            <mx:Label text="Installing this solution will add the following objects to your account:" fontSize="14"/>
        </mx:VBox>
        <mx:HBox id="objectGrids">
        <mx:DataGrid dataProvider="{dataSources}" visible="{showDataSources}" width="200" rowCount="{dataSourceCount}" rowHeight="28">
            <mx:columns>
                <mx:DataGridColumn headerText="" dataField="name" width="50">
                    <mx:itemRenderer>
                        <mx:Component>
                            <mx:HBox width="100%" horizontalAlign="center">
                                <mx:Image source="{outerDocument.dataSourceIcon}"/>
                            </mx:HBox>
                        </mx:Component>
                    </mx:itemRenderer>
                </mx:DataGridColumn>
                <mx:DataGridColumn headerText="Name" dataField="name" headerRenderer="com.easyinsight.groups.CustomGroupHeader"/>
            </mx:columns>
        </mx:DataGrid>
        <mx:DataGrid dataProvider="{insights}" visible="{showInsights}" width="200" rowCount="{reportCount}" rowHeight="28">
            <mx:columns>
                <mx:DataGridColumn headerText="" dataField="name" width="50">
                    <mx:itemRenderer>
                        <mx:Component>
                            <mx:HBox width="100%" horizontalAlign="center">
                                <mx:Image source="{outerDocument.insightIcon}"/>
                            </mx:HBox>
                        </mx:Component>
                    </mx:itemRenderer>
                </mx:DataGridColumn>
                <mx:DataGridColumn headerText="Name" dataField="name" headerRenderer="com.easyinsight.groups.CustomGroupHeader"/>
            </mx:columns>
        </mx:DataGrid>
        <mx:DataGrid dataProvider="{goalTrees}" visible="{showGoalTrees}"  width="200" rowCount="{goalCount}" rowHeight="28">
            <mx:columns>
                <mx:DataGridColumn headerText="" dataField="name" width="50">
                    <mx:itemRenderer>
                        <mx:Component>
                            <mx:HBox width="100%" horizontalAlign="center">
                                <mx:Image source="{outerDocument.goalTreeIcon}"/>
                            </mx:HBox>
                        </mx:Component>
                    </mx:itemRenderer>
                </mx:DataGridColumn>
                <mx:DataGridColumn headerText="Name" dataField="name" headerRenderer="com.easyinsight.groups.CustomGroupHeader"/>
            </mx:columns>
        </mx:DataGrid>
        </mx:HBox>
		<mx:HBox id="buttonBox" width="100%" horizontalAlign="center">
			<mx:Button label="Install" click="install()"/>
			<mx:Button label="Cancel" click="cancel()"/>
		</mx:HBox>		
	</mx:VBox>
</util:EITitleWindow>
